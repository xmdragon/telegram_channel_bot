<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TelegramÊ∂àÊÅØÂÆ°Ê†∏Á≥ªÁªü</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöÄ</text></svg>">
    
    <!-- Â§ñÈÉ®Ê†∑ÂºèÊñá‰ª∂ -->
    <link rel="stylesheet" href="assets/css/element-plus.css">
    <link rel="stylesheet" href="assets/css/starcraft.css">
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/components/index.css">
    <link rel="stylesheet" href="assets/css/components/telegram-message.css">
    <link rel="stylesheet" href="assets/css/components/media-group.css">
    <link rel="stylesheet" href="assets/css/checkbox-fix.css">
    <link rel="stylesheet" href="assets/css/media-error.css">
    
    <!-- Â§ñÈÉ®ËÑöÊú¨Êñá‰ª∂ -->
    <script src="assets/js/vue.prod.js?v=2"></script>
    <script src="assets/js/element-plus.js?v=2"></script>
    <script src="assets/js/axios.js?v=2"></script>
    <script src="assets/js/components/navbar.js"></script>
    <script src="assets/js/message-manager.js?v=1"></script>
    <script src="assets/js/components/index.js?v=2"></script>
</head>
<body>
    <div id="app">
        <!-- ÂØºËà™Ê†è -->
        <nav-bar page-title="üöÄ TELEGRAM Ê∂àÊÅØÂÆ°Ê†∏Á≥ªÁªü" page-subtitle="Êô∫ËÉΩÈááÈõÜ ¬∑ È´òÊïàÂÆ°Ê†∏ ¬∑ Ëá™Âä®ËΩ¨Âèë"></nav-bar>

        <div class="stats-container">
            <!-- ÁªüËÆ°Èù¢Êùø -->
            <el-row :gutter="20" class="stats-card">
                <el-col :span="4" v-for="(stat, key) in stats" :key="key">
                    <el-card class="stat-card" @click="handleStatClick(key)" :class="key">
                        <div class="stat-value">{{ stat.value }}</div>
                        <div class="stat-label">{{ stat.label }}</div>
                    </el-card>
                </el-col>
            </el-row>

            <!-- Â∑•ÂÖ∑Ê†è -->
            <div class="toolbar">
                <div class="filter-group">
                    <!-- ÊêúÁ¥¢Ê°Ü -->
                    <el-input 
                        v-model="searchKeyword" 
                        placeholder="ÊêúÁ¥¢Ê∂àÊÅØÂÜÖÂÆπ..." 
                        clearable
                        @clear="searchMessages"
                        @keyup.enter="searchMessages"
                        style="width: 350px; margin-right: 10px;">
                        <template #prefix>
                            <el-icon><i class="el-icon-search"></i></el-icon>
                        </template>
                        <template #append>
                            <el-button @click="searchMessages">ÊêúÁ¥¢</el-button>
                        </template>
                    </el-input>
                    
                    <el-select v-model="filters.status" placeholder="Áä∂ÊÄÅÁ≠õÈÄâ" clearable @change="loadMessages">
                        <el-option label="ÂæÖÂÆ°Ê†∏" value="pending"></el-option>
                        <el-option label="Â∑≤ÊâπÂáÜ" value="approved"></el-option>
                        <el-option label="Â∑≤ÊãíÁªù" value="rejected"></el-option>
                        <el-option label="Ëá™Âä®ËΩ¨Âèë" value="auto_forwarded"></el-option>
                    </el-select>
                    
                    <el-select v-model="filters.is_ad" placeholder="ÂπøÂëäÁ≠õÈÄâ" clearable @change="loadMessages">
                        <el-option label="ÂπøÂëäÊ∂àÊÅØ" :value="true"></el-option>
                        <el-option label="Ê≠£Â∏∏Ê∂àÊÅØ" :value="false"></el-option>
                    </el-select>
                    
                    <el-button @click="loadMessages" icon="Refresh">Âà∑Êñ∞Êï∞ÊçÆ</el-button>
                </div>
                
                <div class="action-group">
                    <el-button 
                        type="success" 
                        @click="batchApprove" 
                        :disabled="selectedMessages.length === 0"
                        icon="Check">
                        ÊâπÈáèÊâπÂáÜ ({{ selectedMessages.length }})
                    </el-button>
                </div>
            </div>

            <!-- Ê∂àÊÅØÂàóË°® - Á±ª‰ººTelegramÈ¢ëÈÅìÊ†ºÂºè -->
            <div v-for="message in messages" :key="message.id" class="telegram-message" 
                 :class="[message.is_ad ? 'ad-message' : '', message.status, isMessageSelected(message.id) ? 'selected' : '']">
                
                <!-- È¢ëÈÅì‰ø°ÊÅØÂ§¥ -->
                <div class="channel-header">
                    <div class="channel-info">
                        <!-- ÈÄâÊã©Ê°Ü - Âè™Âú®pendingÁä∂ÊÄÅÊòæÁ§∫ -->
                        <el-checkbox 
                            v-if="message.status === 'pending'"
                            :model-value="isMessageSelected(message.id)"
                            @change="toggleMessageSelection(message)"
                            class="message-checkbox"
                            style="margin-right: 10px;">
                        </el-checkbox>
                        <div class="channel-avatar">üì¢</div>
                        <div class="channel-details">
                            <div class="channel-name">{{ getChannelName(message.source_channel) }}</div>
                        </div>
                    </div>
                    <div class="message-status">
                        <el-tag :type="getStatusType(message.status)" size="small">
                            {{ getStatusText(message.status) }}
                        </el-tag>
                        <el-tag v-if="message.is_ad" type="danger" size="small" style="margin-left: 5px;">
                            ÂπøÂëä
                        </el-tag>
                    </div>
                </div>
                
                <!-- Ê∂àÊÅØÂÜÖÂÆπ -->
                <div class="message-content">
                    <!-- ÁªÑÂêàÂ™í‰ΩìÂÜÖÂÆπÔºàÂ™í‰ΩìÁªÑÔºâ -->
                    <div v-if="isCombinedMessage(message)" class="message-media-group">
                        <div class="media-group-container" :data-count="getMediaGroupCount(message)">
                            <div v-for="(media, index) in message.media_group_display" :key="index" class="media-group-item">
                                <!-- ÂõæÁâá -->
                                <div v-if="media.media_type === 'photo' && media.display_url" class="media-display">
                                    <img :src="media.display_url" 
                                         :alt="'ÂõæÁâá ' + index"
                                         :key="`group-photo-${message.id}-${index}-${Date.now()}`"
                                         class="media-image group-media"
                                         @click="openMediaPreview(media.display_url)"
                                         @error="handleMediaError($event, message)">
                                </div>
                                
                                <!-- ËßÜÈ¢ë -->
                                <div v-else-if="media.media_type === 'video' && media.display_url" class="media-display">
                                    <video :src="media.display_url" 
                                           :key="`group-video-${message.id}-${index}-${Date.now()}`"
                                           class="media-video group-media" 
                                           controls
                                           preload="metadata"
                                           @error="handleMediaError($event, message)">
                                        ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËßÜÈ¢ëÊí≠Êîæ„ÄÇ
                                    </video>
                                </div>
                                
                                <!-- Âä®Áîª/GIF -->
                                <div v-else-if="media.media_type === 'animation' && media.display_url" class="media-display">
                                    <img :src="media.display_url" 
                                         :alt="'Âä®Áîª ' + index"
                                         :key="`group-animation-${message.id}-${index}-${Date.now()}`"
                                         class="media-image group-media"
                                         @click="openMediaPreview(media.display_url)"
                                         @error="handleMediaError($event, message)">
                                </div>
                                
                                <!-- ÊñáÊ°£ -->
                                <div v-else-if="media.media_type === 'document' && media.display_url" class="media-document group-media">
                                    <div class="document-icon">üìÑ</div>
                                    <div class="document-info">
                                        <div class="document-name">ÊñáÊ°£Êñá‰ª∂</div>
                                        <div class="document-size">ÁÇπÂáª‰∏ãËΩΩ</div>
                                    </div>
                                    <a :href="media.display_url" 
                                       class="download-button" 
                                       target="_blank" 
                                       download>
                                        ‰∏ãËΩΩ
                                    </a>
                                </div>
                                
                                <!-- ‰∏çÊîØÊåÅÁöÑÂ™í‰ΩìÁ±ªÂûã -->
                                <div v-else class="media-placeholder group-media">
                                    {{ getMediaTypeIcon(media.media_type) }} {{ media.media_type }}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Âçï‰∏™Â™í‰ΩìÂÜÖÂÆπ -->
                    <div v-else-if="message.media_type && !isCombinedMessage(message)" class="message-media">
                        <!-- ÂõæÁâáÊòæÁ§∫ -->
                        <div v-if="message.media_type === 'photo' && message.media_display_url" class="media-display">
                            <img :src="message.media_display_url" 
                                 :alt="'ÂõæÁâá ' + message.id"
                                 :key="`photo-${message.id}-${Date.now()}`"
                                 class="media-image"
                                 @click="openMediaPreview(message.media_display_url)"
                                 @error="handleMediaError($event, message)">
                        </div>
                        
                        <!-- ËßÜÈ¢ëÊòæÁ§∫ -->
                        <div v-else-if="message.media_type === 'video' && message.media_display_url" class="media-display">
                            <video :src="message.media_display_url" 
                                   :key="`video-${message.id}-${Date.now()}`"
                                   class="media-video" 
                                   controls
                                   preload="metadata"
                                   @error="handleMediaError($event, message)">
                                ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËßÜÈ¢ëÊí≠Êîæ„ÄÇ
                            </video>
                        </div>
                        
                        <!-- Âä®Áîª/GIFÊòæÁ§∫ -->
                        <div v-else-if="message.media_type === 'animation' && message.media_display_url" class="media-display">
                            <img :src="message.media_display_url" 
                                 :alt="'Âä®Áîª ' + message.id"
                                 :key="`animation-${message.id}-${Date.now()}`"
                                 class="media-image"
                                 @click="openMediaPreview(message.media_display_url)"
                                 @error="handleMediaError($event, message)">
                        </div>
                        
                        <!-- ÊñáÊ°£ÊòæÁ§∫ -->
                        <div v-else-if="message.media_type === 'document' && message.media_display_url" class="media-document">
                            <div class="document-icon">üìÑ</div>
                            <div class="document-info">
                                <div class="document-name">ÊñáÊ°£Êñá‰ª∂</div>
                                <div class="document-size">ÁÇπÂáª‰∏ãËΩΩ</div>
                            </div>
                            <a :href="message.media_display_url" 
                               class="download-button" 
                               target="_blank" 
                               download>
                                ‰∏ãËΩΩ
                            </a>
                        </div>
                        
                        <!-- Â™í‰ΩìÂä†ËΩΩÈîôËØØÊàñ‰∏çÊîØÊåÅÁöÑÁ±ªÂûã -->
                        <div v-else class="media-placeholder">
                            <span v-if="message.media_type === 'photo'">üñºÔ∏è ÂõæÁâá</span>
                            <span v-else-if="message.media_type === 'video'">üé• ËßÜÈ¢ë</span>
                            <span v-else-if="message.media_type === 'document'">üìÑ ÊñáÊ°£</span>
                            <span v-else-if="message.media_type === 'animation'">üé¨ Âä®Áîª</span>
                            <span v-else-if="message.media_type === 'audio'">üéß Èü≥È¢ë</span>
                            <span v-else>üìé {{ message.media_type }}</span>
                        </div>
                    </div>
                    
                    <!-- ÊñáÊú¨ÂÜÖÂÆπ -->
                    <div v-if="formatMessageContent(message)" class="message-text">
                        {{ formatMessageContent(message) }}
                    </div>
                </div>
                
                <!-- Ê∂àÊÅØÂ∫ïÈÉ® -->
                <div class="message-footer">
                    <div class="message-time">
                        <span>üï∞Ô∏è {{ formatTime(message.created_at) }}</span>
                        <span style="margin-left: 10px; color: #888;">#{{ message.message_id }}</span>
                        <!-- ÂéüÊ∂àÊÅØÈìæÊé• -->
                        <a v-if="message.source_channel && message.message_id" 
                           :href="getOriginalMessageLink(message)"
                           target="_blank"
                           class="original-link"
                           style="margin-left: 15px; color: #00d4ff; text-decoration: none; font-size: 12px;">
                            üìé Êü•ÁúãÂéüÊ∂àÊÅØ
                        </a>
                    </div>
                    
                    <!-- Êìç‰ΩúÊåâÈíÆ -->
                    <div class="message-actions">
                        <el-button 
                            type="primary" 
                            size="small" 
                            @click="publishMessage(message.id)"
                            icon="Promotion">
                            ÂèëÂ∏É
                        </el-button>
                        <el-button 
                            type="warning" 
                            size="small" 
                            @click="editMessage(message)"
                            icon="Edit">
                            ÁºñËæë
                        </el-button>
                        <el-button 
                            type="danger" 
                            size="small" 
                            @click="rejectMessage(message.id)"
                            icon="Delete">
                            ÊãíÁªù
                        </el-button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Áä∂ÊÄÅÊ∂àÊÅØ -->
        <div v-if="statusMessage" class="status-message" :class="statusType">
            {{ statusMessage }}
        </div>
        
        <!-- Â™í‰ΩìÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü -->
        <div v-if="mediaPreview.show" class="media-preview-modal" @click="closeMediaPreview">
            <div class="media-preview-content" @click.stop>
                <button class="media-preview-close" @click="closeMediaPreview">√ó</button>
                <img :src="mediaPreview.url" class="media-preview-image" alt="Â™í‰ΩìÈ¢ÑËßà">
            </div>
        </div>
        
        <!-- Âä†ËΩΩÈÅÆÁΩ© -->
        <div v-if="loading" class="loading-overlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p style="margin-top: 15px; color: #00ff41;">{{ loadingMessage }}</p>
            </div>
        </div>
        
        <!-- ÁºñËæëÊ∂àÊÅØÂØπËØùÊ°Ü -->
        <el-dialog v-model="editDialog.visible" title="ÁºñËæëÊ∂àÊÅØ" width="70%">
            <el-form>
                <el-form-item label="Ê∂àÊÅØÂÜÖÂÆπ">
                    <el-input 
                        v-model="editDialog.content" 
                        type="textarea" 
                        :rows="10"
                        placeholder="ËØ∑ËæìÂÖ•Ê∂àÊÅØÂÜÖÂÆπ">
                    </el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="editDialog.visible = false">ÂèñÊ∂à</el-button>
                    <el-button type="primary" @click="saveEditedMessage">‰øùÂ≠ò</el-button>
                </span>
            </template>
        </el-dialog>
    </div>

</body>
</html>