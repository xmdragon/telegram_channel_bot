<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegramæ¶ˆæ¯å®¡æ ¸ç³»ç»Ÿ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸš€</text></svg>">
    
    <!-- å¤–éƒ¨æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="assets/css/element-plus.css">
    <link rel="stylesheet" href="assets/css/starcraft.css">
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/components/index.css">
    <link rel="stylesheet" href="assets/css/components/telegram-message.css">
    <link rel="stylesheet" href="assets/css/components/media-group.css">
    
    <!-- å¤–éƒ¨è„šæœ¬æ–‡ä»¶ -->
    <script src="assets/js/vue.prod.js?v=2"></script>
    <script src="assets/js/element-plus.js?v=2"></script>
    <script src="assets/js/axios.js?v=2"></script>
    <script src="assets/js/message-manager.js?v=1"></script>
    <script src="assets/js/components/index.js?v=2"></script>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>ğŸš€ TELEGRAM æ¶ˆæ¯å®¡æ ¸ç³»ç»Ÿ</h1>
            <p>æ™ºèƒ½é‡‡é›† Â· é«˜æ•ˆå®¡æ ¸ Â· è‡ªåŠ¨è½¬å‘</p>
        </div>

        <!-- å¯¼èˆªæ  -->
        <div class="nav-bar">
            <div class="nav-links">
                <a href="/" class="nav-link active">ğŸ  ä¸»æ§åˆ¶å°</a>
                <a href="/config" class="nav-link">âš™ï¸ ç³»ç»Ÿé…ç½®</a>
                <a href="/keywords" class="nav-link">ğŸ” å…³é”®è¯ç®¡ç†</a>
                <a href="/status" class="nav-link">ğŸ“Š ç³»ç»ŸçŠ¶æ€</a>
                <a href="/auth" class="nav-link">ğŸ” Telegramç™»å½•</a>
            </div>
            <div class="nav-links">
                <span style="color: #7fdbff; font-weight: 700;">ç³»ç»ŸçŠ¶æ€: {{ systemStatus }}</span>
            </div>
        </div>

        <div class="stats-container">
            <!-- ç»Ÿè®¡é¢æ¿ -->
            <el-row :gutter="20" class="stats-card">
                <el-col :span="4" v-for="(stat, key) in stats" :key="key">
                    <el-card class="stat-card" @click="handleStatClick(key)" :class="key">
                        <div class="stat-value">{{ stat.value }}</div>
                        <div class="stat-label">{{ stat.label }}</div>
                        <div class="stat-hint">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
                    </el-card>
                </el-col>
            </el-row>

            <!-- å·¥å…·æ  -->
            <div class="toolbar">
                <div class="filter-group">
                    <el-select v-model="filters.status" placeholder="çŠ¶æ€ç­›é€‰" clearable @change="loadMessages">
                        <el-option label="å¾…å®¡æ ¸" value="pending"></el-option>
                        <el-option label="å·²æ‰¹å‡†" value="approved"></el-option>
                        <el-option label="å·²æ‹’ç»" value="rejected"></el-option>
                        <el-option label="è‡ªåŠ¨è½¬å‘" value="auto_forwarded"></el-option>
                    </el-select>
                    
                    <el-select v-model="filters.is_ad" placeholder="å¹¿å‘Šç­›é€‰" clearable @change="loadMessages">
                        <el-option label="å¹¿å‘Šæ¶ˆæ¯" :value="true"></el-option>
                        <el-option label="æ­£å¸¸æ¶ˆæ¯" :value="false"></el-option>
                    </el-select>
                    
                    <el-button @click="loadMessages" icon="Refresh">åˆ·æ–°æ•°æ®</el-button>
                </div>
                
                <div class="action-group">
                    <el-button 
                        type="success" 
                        @click="batchApprove" 
                        :disabled="selectedMessages.length === 0"
                        icon="Check">
                        æ‰¹é‡æ‰¹å‡† ({{ selectedMessages.length }})
                    </el-button>
                </div>
            </div>

            <!-- æ¶ˆæ¯åˆ—è¡¨ - ç±»ä¼¼Telegramé¢‘é“æ ¼å¼ -->
            <div v-for="message in messages" :key="message.id" class="telegram-message" 
                 :class="[message.is_ad ? 'ad-message' : '', message.status]">
                
                <!-- é¢‘é“ä¿¡æ¯å¤´ -->
                <div class="channel-header">
                    <div class="channel-info">
                        <div class="channel-avatar">ğŸ“¢</div>
                        <div class="channel-details">
                            <div class="channel-name">{{ getChannelName(message.source_channel) }}</div>
                        </div>
                    </div>
                    <div class="message-status">
                        <el-tag :type="getStatusType(message.status)" size="small">
                            {{ getStatusText(message.status) }}
                        </el-tag>
                        <el-tag v-if="message.is_ad" type="danger" size="small" style="margin-left: 5px;">
                            å¹¿å‘Š
                        </el-tag>
                    </div>
                </div>
                
                <!-- æ¶ˆæ¯å†…å®¹ -->
                <div class="message-content">
                    <!-- ç»„åˆåª’ä½“å†…å®¹ï¼ˆåª’ä½“ç»„ï¼‰ -->
                    <div v-if="isCombinedMessage(message)" class="message-media-group">
                        <div class="media-group-container" :data-count="getMediaGroupCount(message)">
                            <div v-for="(media, index) in message.media_group_display" :key="index" class="media-group-item">
                                <!-- å›¾ç‰‡ -->
                                <div v-if="media.media_type === 'photo' && media.display_url" class="media-display">
                                    <img :src="media.display_url" 
                                         :alt="'å›¾ç‰‡ ' + index"
                                         class="media-image group-media"
                                         @click="openMediaPreview(media.display_url)"
                                         @error="handleMediaError($event, message)">
                                </div>
                                
                                <!-- è§†é¢‘ -->
                                <div v-else-if="media.media_type === 'video' && media.display_url" class="media-display">
                                    <video :src="media.display_url" 
                                           class="media-video group-media" 
                                           controls
                                           preload="metadata"
                                           @error="handleMediaError($event, message)">
                                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                                    </video>
                                </div>
                                
                                <!-- åŠ¨ç”»/GIF -->
                                <div v-else-if="media.media_type === 'animation' && media.display_url" class="media-display">
                                    <img :src="media.display_url" 
                                         :alt="'åŠ¨ç”» ' + index"
                                         class="media-image group-media"
                                         @click="openMediaPreview(media.display_url)"
                                         @error="handleMediaError($event, message)">
                                </div>
                                
                                <!-- æ–‡æ¡£ -->
                                <div v-else-if="media.media_type === 'document' && media.display_url" class="media-document group-media">
                                    <div class="document-icon">ğŸ“„</div>
                                    <div class="document-info">
                                        <div class="document-name">æ–‡æ¡£æ–‡ä»¶</div>
                                        <div class="document-size">ç‚¹å‡»ä¸‹è½½</div>
                                    </div>
                                    <a :href="media.display_url" 
                                       class="download-button" 
                                       target="_blank" 
                                       download>
                                        ä¸‹è½½
                                    </a>
                                </div>
                                
                                <!-- ä¸æ”¯æŒçš„åª’ä½“ç±»å‹ -->
                                <div v-else class="media-placeholder group-media">
                                    {{ getMediaTypeIcon(media.media_type) }} {{ media.media_type }}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å•ä¸ªåª’ä½“å†…å®¹ -->
                    <div v-else-if="message.media_type && !isCombinedMessage(message)" class="message-media">
                        <!-- å›¾ç‰‡æ˜¾ç¤º -->
                        <div v-if="message.media_type === 'photo' && message.media_display_url" class="media-display">
                            <img :src="message.media_display_url" 
                                 :alt="'å›¾ç‰‡ ' + message.id"
                                 class="media-image"
                                 @click="openMediaPreview(message.media_display_url)"
                                 @error="handleMediaError($event, message)">
                        </div>
                        
                        <!-- è§†é¢‘æ˜¾ç¤º -->
                        <div v-else-if="message.media_type === 'video' && message.media_display_url" class="media-display">
                            <video :src="message.media_display_url" 
                                   class="media-video" 
                                   controls
                                   preload="metadata"
                                   @error="handleMediaError($event, message)">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                            </video>
                        </div>
                        
                        <!-- åŠ¨ç”»/GIFæ˜¾ç¤º -->
                        <div v-else-if="message.media_type === 'animation' && message.media_display_url" class="media-display">
                            <img :src="message.media_display_url" 
                                 :alt="'åŠ¨ç”» ' + message.id"
                                 class="media-image"
                                 @click="openMediaPreview(message.media_display_url)"
                                 @error="handleMediaError($event, message)">
                        </div>
                        
                        <!-- æ–‡æ¡£æ˜¾ç¤º -->
                        <div v-else-if="message.media_type === 'document' && message.media_display_url" class="media-document">
                            <div class="document-icon">ğŸ“„</div>
                            <div class="document-info">
                                <div class="document-name">æ–‡æ¡£æ–‡ä»¶</div>
                                <div class="document-size">ç‚¹å‡»ä¸‹è½½</div>
                            </div>
                            <a :href="message.media_display_url" 
                               class="download-button" 
                               target="_blank" 
                               download>
                                ä¸‹è½½
                            </a>
                        </div>
                        
                        <!-- åª’ä½“åŠ è½½é”™è¯¯æˆ–ä¸æ”¯æŒçš„ç±»å‹ -->
                        <div v-else class="media-placeholder">
                            <span v-if="message.media_type === 'photo'">ğŸ–¼ï¸ å›¾ç‰‡</span>
                            <span v-else-if="message.media_type === 'video'">ğŸ¥ è§†é¢‘</span>
                            <span v-else-if="message.media_type === 'document'">ğŸ“„ æ–‡æ¡£</span>
                            <span v-else-if="message.media_type === 'animation'">ğŸ¬ åŠ¨ç”»</span>
                            <span v-else-if="message.media_type === 'audio'">ğŸ§ éŸ³é¢‘</span>
                            <span v-else>ğŸ“ {{ message.media_type }}</span>
                        </div>
                    </div>
                    
                    <!-- æ–‡æœ¬å†…å®¹ -->
                    <div v-if="formatMessageContent(message)" class="message-text">
                        {{ formatMessageContent(message) }}
                    </div>
                </div>
                
                <!-- æ¶ˆæ¯åº•éƒ¨ -->
                <div class="message-footer">
                    <div class="message-time">
                        <span>ğŸ•°ï¸ {{ formatTime(message.created_at) }}</span>
                        <span style="margin-left: 10px; color: #888;">#{{ message.message_id }}</span>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="message-actions">
                        <el-button 
                            type="primary" 
                            size="small" 
                            @click="publishMessage(message.id)"
                            icon="Promotion">
                            å‘å¸ƒ
                        </el-button>
                        <el-button 
                            type="warning" 
                            size="small" 
                            @click="editMessage(message)"
                            icon="Edit">
                            ç¼–è¾‘
                        </el-button>
                        <el-button 
                            type="danger" 
                            size="small" 
                            @click="rejectMessage(message.id)"
                            icon="Delete">
                            æ‹’ç»
                        </el-button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- çŠ¶æ€æ¶ˆæ¯ -->
        <div v-if="statusMessage" class="status-message" :class="statusType">
            {{ statusMessage }}
        </div>
        
        <!-- åª’ä½“é¢„è§ˆæ¨¡æ€æ¡† -->
        <div v-if="mediaPreview.show" class="media-preview-modal" @click="closeMediaPreview">
            <div class="media-preview-content" @click.stop>
                <button class="media-preview-close" @click="closeMediaPreview">Ã—</button>
                <img :src="mediaPreview.url" class="media-preview-image" alt="åª’ä½“é¢„è§ˆ">
            </div>
        </div>
        
        <!-- åŠ è½½é®ç½© -->
        <div v-if="loading" class="loading-overlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p style="margin-top: 15px; color: #00ff41;">{{ loadingMessage }}</p>
            </div>
        </div>
        
        <!-- ç¼–è¾‘æ¶ˆæ¯å¯¹è¯æ¡† -->
        <el-dialog v-model="editDialog.visible" title="ç¼–è¾‘æ¶ˆæ¯" width="70%">
            <el-form>
                <el-form-item label="æ¶ˆæ¯å†…å®¹">
                    <el-input 
                        v-model="editDialog.content" 
                        type="textarea" 
                        :rows="10"
                        placeholder="è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹">
                    </el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="editDialog.visible = false">å–æ¶ˆ</el-button>
                    <el-button type="primary" @click="saveEditedMessage">ä¿å­˜</el-button>
                </span>
            </template>
        </el-dialog>
    </div>

</body>
</html>