<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegramæ¶ˆæ¯å®¡æ ¸ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .stats-card {
            margin: 20px 0;
        }
        .message-card {
            margin: 10px 0;
            border-left: 4px solid #409EFF;
        }
        .message-card.ad {
            border-left-color: #F56C6C;
        }
        .message-card.approved {
            border-left-color: #67C23A;
        }
        .message-card.rejected {
            border-left-color: #E6A23C;
        }
        .content-preview {
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .toolbar {
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>ğŸ“± Telegramæ¶ˆæ¯å®¡æ ¸ç³»ç»Ÿ</h1>
            <p>æ™ºèƒ½é‡‡é›† Â· é«˜æ•ˆå®¡æ ¸ Â· è‡ªåŠ¨è½¬å‘</p>
        </div>

        <el-container style="padding: 20px;">
            <!-- ç»Ÿè®¡é¢æ¿ -->
            <el-row :gutter="20" class="stats-card">
                <el-col :span="4" v-for="(stat, key) in stats" :key="key">
                    <el-card>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #409EFF;">
                                {{ stat.value }}
                            </div>
                            <div style="color: #666; margin-top: 5px;">
                                {{ stat.label }}
                            </div>
                        </div>
                    </el-card>
                </el-col>
            </el-row>

            <!-- å·¥å…·æ  -->
            <div class="toolbar">
                <div>
                    <el-select v-model="filters.status" placeholder="çŠ¶æ€ç­›é€‰" clearable @change="loadMessages">
                        <el-option label="å¾…å®¡æ ¸" value="pending"></el-option>
                        <el-option label="å·²æ‰¹å‡†" value="approved"></el-option>
                        <el-option label="å·²æ‹’ç»" value="rejected"></el-option>
                        <el-option label="è‡ªåŠ¨è½¬å‘" value="auto_forwarded"></el-option>
                    </el-select>
                    
                    <el-select v-model="filters.is_ad" placeholder="å¹¿å‘Šç­›é€‰" clearable @change="loadMessages">
                        <el-option label="å¹¿å‘Šæ¶ˆæ¯" :value="true"></el-option>
                        <el-option label="æ­£å¸¸æ¶ˆæ¯" :value="false"></el-option>
                    </el-select>
                    
                    <el-button @click="loadMessages" icon="Refresh">åˆ·æ–°</el-button>
                </div>
                
                <div>
                    <el-button 
                        type="success" 
                        @click="batchApprove" 
                        :disabled="selectedMessages.length === 0"
                        icon="Check">
                        æ‰¹é‡æ‰¹å‡† ({{ selectedMessages.length }})
                    </el-button>
                </div>
            </div>

            <!-- æ¶ˆæ¯åˆ—è¡¨ -->
            <el-card>
                <template #header>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>æ¶ˆæ¯åˆ—è¡¨</span>
                        <el-checkbox v-model="selectAll" @change="handleSelectAll">å…¨é€‰</el-checkbox>
                    </div>
                </template>

                <div v-loading="loading">
                    <div v-for="message in messages" :key="message.id" 
                         :class="['message-card', message.status, { 'ad': message.is_ad }]">
                        <el-card>
                            <div style="display: flex; align-items: flex-start;">
                                <el-checkbox 
                                    v-model="selectedMessages" 
                                    :label="message.id"
                                    style="margin-right: 15px; margin-top: 5px;">
                                </el-checkbox>
                                
                                <div style="flex: 1;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <div>
                                            <el-tag :type="getStatusType(message.status)">
                                                {{ getStatusText(message.status) }}
                                            </el-tag>
                                            <el-tag v-if="message.is_ad" type="danger" style="margin-left: 5px;">
                                                å¹¿å‘Š
                                            </el-tag>
                                            <span style="margin-left: 10px; color: #666; font-size: 12px;">
                                                æ¥æº: {{ message.source_channel }}
                                            </span>
                                        </div>
                                        <div>
                                            <el-button-group>
                                                <el-button 
                                                    size="small" 
                                                    @click="viewMessage(message)"
                                                    icon="View">
                                                    è¯¦æƒ…
                                                </el-button>
                                                <el-button 
                                                    v-if="message.status === 'pending'"
                                                    size="small" 
                                                    type="success"
                                                    @click="approveMessage(message.id)"
                                                    icon="Check">
                                                    æ‰¹å‡†
                                                </el-button>
                                                <el-button 
                                                    v-if="message.status === 'pending'"
                                                    size="small" 
                                                    type="danger"
                                                    @click="rejectMessage(message.id)"
                                                    icon="Close">
                                                    æ‹’ç»
                                                </el-button>
                                            </el-button-group>
                                        </div>
                                    </div>
                                    
                                    <div class="content-preview">
                                        {{ message.content }}
                                    </div>
                                    
                                    <div style="margin-top: 10px; color: #999; font-size: 12px;">
                                        åˆ›å»ºæ—¶é—´: {{ formatTime(message.created_at) }}
                                        <span v-if="message.reviewed_by" style="margin-left: 20px;">
                                            å®¡æ ¸äºº: {{ message.reviewed_by }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </el-card>
                    </div>
                </div>

                <!-- åˆ†é¡µ -->
                <div style="text-align: center; margin-top: 20px;">
                    <el-pagination
                        v-model:current-page="pagination.page"
                        :page-size="pagination.size"
                        :total="pagination.total"
                        layout="prev, pager, next, jumper"
                        @current-change="loadMessages">
                    </el-pagination>
                </div>
            </el-card>
        </el-container>

        <!-- æ¶ˆæ¯è¯¦æƒ…å¯¹è¯æ¡† -->
        <el-dialog v-model="dialogVisible" title="æ¶ˆæ¯è¯¦æƒ…" width="60%">
            <div v-if="currentMessage">
                <el-descriptions :column="2" border>
                    <el-descriptions-item label="æ¶ˆæ¯ID">{{ currentMessage.id }}</el-descriptions-item>
                    <el-descriptions-item label="çŠ¶æ€">
                        <el-tag :type="getStatusType(currentMessage.status)">
                            {{ getStatusText(currentMessage.status) }}
                        </el-tag>
                    </el-descriptions-item>
                    <el-descriptions-item label="æ¥æºé¢‘é“">{{ currentMessage.source_channel }}</el-descriptions-item>
                    <el-descriptions-item label="åª’ä½“ç±»å‹">{{ currentMessage.media_type || 'æ–‡æœ¬' }}</el-descriptions-item>
                    <el-descriptions-item label="æ˜¯å¦å¹¿å‘Š">
                        <el-tag :type="currentMessage.is_ad ? 'danger' : 'success'">
                            {{ currentMessage.is_ad ? 'æ˜¯' : 'å¦' }}
                        </el-tag>
                    </el-descriptions-item>
                    <el-descriptions-item label="å®¡æ ¸äºº">{{ currentMessage.reviewed_by || 'æœªå®¡æ ¸' }}</el-descriptions-item>
                </el-descriptions>
                
                <el-divider>åŸå§‹å†…å®¹</el-divider>
                <div style="background: #f5f5f5; padding: 15px; border-radius: 4px;">
                    {{ currentMessage.content }}
                </div>
                
                <el-divider>è¿‡æ»¤åå†…å®¹</el-divider>
                <div style="background: #f0f9ff; padding: 15px; border-radius: 4px;">
                    {{ currentMessage.filtered_content }}
                </div>
            </div>
        </el-dialog>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            data() {
                return {
                    loading: false,
                    messages: [],
                    stats: {
                        total: { label: 'æ€»æ¶ˆæ¯', value: 0 },
                        pending: { label: 'å¾…å®¡æ ¸', value: 0 },
                        approved: { label: 'å·²æ‰¹å‡†', value: 0 },
                        rejected: { label: 'å·²æ‹’ç»', value: 0 },
                        ads: { label: 'å¹¿å‘Šæ¶ˆæ¯', value: 0 },
                        auto_forwarded: { label: 'è‡ªåŠ¨è½¬å‘', value: 0 }
                    },
                    filters: {
                        status: '',
                        is_ad: null
                    },
                    pagination: {
                        page: 1,
                        size: 20,
                        total: 0
                    },
                    selectedMessages: [],
                    selectAll: false,
                    dialogVisible: false,
                    currentMessage: null
                }
            },
            mounted() {
                this.loadStats();
                this.loadMessages();
            },
            methods: {
                async loadStats() {
                    try {
                        const response = await axios.get('/api/messages/stats/overview');
                        const data = response.data;
                        this.stats.total.value = data.total;
                        this.stats.pending.value = data.pending;
                        this.stats.approved.value = data.approved;
                        this.stats.rejected.value = data.rejected;
                        this.stats.ads.value = data.ads;
                        this.stats.auto_forwarded.value = data.auto_forwarded;
                    } catch (error) {
                        ElMessage.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥');
                    }
                },
                
                async loadMessages() {
                    this.loading = true;
                    try {
                        const params = {
                            page: this.pagination.page,
                            size: this.pagination.size,
                            ...this.filters
                        };
                        
                        const response = await axios.get('/api/messages/', { params });
                        this.messages = response.data.messages;
                        this.pagination.total = response.data.total || this.messages.length * 10; // ä¼°ç®—æ€»æ•°
                    } catch (error) {
                        ElMessage.error('åŠ è½½æ¶ˆæ¯åˆ—è¡¨å¤±è´¥');
                    } finally {
                        this.loading = false;
                    }
                },
                
                async approveMessage(messageId) {
                    try {
                        await axios.post(`/api/messages/${messageId}/approve`, {
                            reviewer: 'admin' // è¿™é‡Œåº”è¯¥ä»ç”¨æˆ·ç™»å½•ä¿¡æ¯è·å–
                        });
                        ElMessage.success('æ¶ˆæ¯å·²æ‰¹å‡†');
                        this.loadMessages();
                        this.loadStats();
                    } catch (error) {
                        ElMessage.error('æ‰¹å‡†å¤±è´¥');
                    }
                },
                
                async rejectMessage(messageId) {
                    try {
                        await axios.post(`/api/messages/${messageId}/reject`, {
                            reviewer: 'admin'
                        });
                        ElMessage.success('æ¶ˆæ¯å·²æ‹’ç»');
                        this.loadMessages();
                        this.loadStats();
                    } catch (error) {
                        ElMessage.error('æ‹’ç»å¤±è´¥');
                    }
                },
                
                async batchApprove() {
                    if (this.selectedMessages.length === 0) return;
                    
                    try {
                        await ElMessageBox.confirm(
                            `ç¡®å®šè¦æ‰¹å‡†é€‰ä¸­çš„ ${this.selectedMessages.length} æ¡æ¶ˆæ¯å—ï¼Ÿ`,
                            'æ‰¹é‡æ“ä½œç¡®è®¤'
                        );
                        
                        await axios.post('/api/messages/batch-approve', {
                            message_ids: this.selectedMessages,
                            reviewer: 'admin'
                        });
                        
                        ElMessage.success('æ‰¹é‡æ‰¹å‡†æˆåŠŸ');
                        this.selectedMessages = [];
                        this.selectAll = false;
                        this.loadMessages();
                        this.loadStats();
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('æ‰¹é‡æ‰¹å‡†å¤±è´¥');
                        }
                    }
                },
                
                async viewMessage(message) {
                    try {
                        const response = await axios.get(`/api/messages/${message.id}`);
                        this.currentMessage = response.data;
                        this.dialogVisible = true;
                    } catch (error) {
                        ElMessage.error('åŠ è½½æ¶ˆæ¯è¯¦æƒ…å¤±è´¥');
                    }
                },
                
                handleSelectAll(val) {
                    if (val) {
                        this.selectedMessages = this.messages.map(m => m.id);
                    } else {
                        this.selectedMessages = [];
                    }
                },
                
                getStatusType(status) {
                    const types = {
                        pending: 'warning',
                        approved: 'success',
                        rejected: 'danger',
                        auto_forwarded: 'info'
                    };
                    return types[status] || 'info';
                },
                
                getStatusText(status) {
                    const texts = {
                        pending: 'å¾…å®¡æ ¸',
                        approved: 'å·²æ‰¹å‡†',
                        rejected: 'å·²æ‹’ç»',
                        auto_forwarded: 'è‡ªåŠ¨è½¬å‘'
                    };
                    return texts[status] || status;
                },
                
                formatTime(timeStr) {
                    return new Date(timeStr).toLocaleString('zh-CN');
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>