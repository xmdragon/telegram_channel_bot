<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🤖 AI训练中心</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    
    <link rel="stylesheet" href="assets/css/element-plus.css">
    <link rel="stylesheet" href="assets/css/element-plus-fixes.css">
    <link rel="stylesheet" href="assets/css/modern-ui.css">
    <link rel="stylesheet" href="assets/css/training-common.css">
    <link rel="stylesheet" href="assets/css/training-manager.css">
    <link rel="stylesheet" href="assets/css/train.css">
    <link rel="stylesheet" href="assets/css/training-nav.css">
</head>
<body>
    <div id="app">
        <!-- 导航栏 -->
        <nav-bar page-title="🤖 AI训练中心"></nav-bar>
        
        <div class="container">
            <!-- 子导航 -->
            <training-nav :active-tab="trainingMode"></training-nav>
            
            <!-- AI训练标签页 -->
            <el-tabs v-model="activeTab" type="border-card" class="config-tabs" v-if="trainingMode !== 'data'">
                <!-- 手动训练 -->
                <el-tab-pane label="✏️ 手动训练" name="train">
                    <div class="config-section" v-if="trainingMode === 'tail'">
                        <!-- 统计信息栏 -->
                        <div class="stats-section compact">
                            <div class="stats-inline">
                                <div class="stat-item-inline">
                                    <span class="stat-label">总样本数:</span>
                                    <span class="stat-value">{{ stats.totalChannels }}</span>
                                </div>
                                <div class="stat-item-inline">
                                    <span class="stat-label">有效样本:</span>
                                    <span class="stat-value">{{ stats.trainedChannels }}</span>
                                </div>
                                <div class="stat-item-inline">
                                    <span class="stat-label">包含分隔符:</span>
                                    <span class="stat-value">{{ stats.totalSamples }}</span>
                                </div>
                                <div class="stat-item-inline">
                                    <span class="stat-label">今日新增:</span>
                                    <span class="stat-value">{{ stats.todayTraining }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- 训练表单 -->
                        <el-card class="training-form-card">
                            <template #header>
                                <div class="card-header">
                                    <span>📝 添加训练样本</span>
                                </div>
                            </template>
                            
                            <el-form :model="trainingForm" label-width="120px" label-position="top">
                                <el-form-item label="原始消息内容" required>
                                    <el-input
                                        v-model="trainingForm.original_message"
                                        type="textarea"
                                        :rows="8"
                                        placeholder="粘贴完整的原始消息内容，包括正文和尾部推广..."
                                        @input="updatePreview">
                                    </el-input>
                                    <div class="char-count">{{ trainingForm.original_message.length }} 字符</div>
                                </el-form-item>
                                
                                <el-form-item label="推广尾部内容" required>
                                    <el-input
                                        v-model="trainingForm.tail_content"
                                        type="textarea"
                                        :rows="6"
                                        placeholder="粘贴需要过滤的尾部内容，如：
👌订阅频道：@miandianDs
👌投稿爆料：@QianQian106
👌海外交友：@tmiandianKs"
                                        @input="updatePreview">
                                    </el-input>
                                    <div class="char-count">{{ trainingForm.tail_content.length }} 字符</div>
                                </el-form-item>
                                
                                <!-- 预览区域 -->
                                <el-form-item label="过滤后预览" v-if="filteredPreview">
                                    <div class="preview-box">
                                        <pre>{{ filteredPreview }}</pre>
                                    </div>
                                </el-form-item>
                                
                                <el-form-item>
                                    <el-button @click="clearForm">清空</el-button>
                                    <el-button type="primary" @click="submitTraining" :loading="submitting">
                                        提交训练样本
                                    </el-button>
                                </el-form-item>
                            </el-form>
                        </el-card>
                    </div>
                    
                    <!-- 广告检测训练表单 -->
                    <div class="config-section" v-if="trainingMode === 'ad'">
                        <el-card class="training-form-card">
                            <template #header>
                                <div class="card-header">
                                    <span>🚫 广告检测训练</span>
                                </div>
                            </template>
                            
                            <el-form :model="adTrainingForm" label-width="120px" label-position="top">
                                <el-form-item label="训练内容" required>
                                    <el-input
                                        v-model="adTrainingForm.content"
                                        type="textarea"
                                        :rows="8"
                                        placeholder="粘贴需要训练的消息内容（广告或正常消息）...">
                                    </el-input>
                                </el-form-item>
                                
                                <el-form-item label="标记类型" required>
                                    <el-radio-group v-model="adTrainingForm.is_ad">
                                        <el-radio :label="true">🚫 这是广告</el-radio>
                                        <el-radio :label="false">✅ 这是正常消息</el-radio>
                                    </el-radio-group>
                                </el-form-item>
                                
                                <el-form-item label="描述说明">
                                    <el-input
                                        v-model="adTrainingForm.description"
                                        type="textarea"
                                        :rows="3"
                                        placeholder="可选：描述这条消息的特征，如'频道推广列表'、'隐藏按钮广告'等">
                                    </el-input>
                                </el-form-item>
                                
                                <el-form-item>
                                    <el-button @click="adTrainingForm = {content: '', is_ad: true, description: ''}">清空</el-button>
                                    <el-button type="primary" @click="submitAdTraining" :loading="submitting">
                                        提交广告训练样本
                                    </el-button>
                                </el-form-item>
                            </el-form>
                        </el-card>
                    </div>
                    
                    <!-- 分隔符配置表单 -->
                    <div class="config-section" v-if="trainingMode === 'separator'">
                        <el-card class="training-form-card">
                            <template #header>
                                <div class="card-header">
                                    <span>⚙️ 分隔符模式配置</span>
                                    <el-button type="primary" size="small" @click="saveSeparatorPatterns">
                                        保存配置
                                    </el-button>
                                </div>
                            </template>
                            
                            <div class="separator-patterns">
                                <div v-for="(pattern, index) in separatorPatterns" :key="index" class="pattern-item">
                                    <el-row :gutter="10">
                                        <el-col :span="10">
                                            <el-input
                                                v-model="pattern.regex"
                                                placeholder="正则表达式，如：━{10,}">
                                            </el-input>
                                        </el-col>
                                        <el-col :span="10">
                                            <el-input
                                                v-model="pattern.description"
                                                placeholder="描述，如：横线分隔符">
                                            </el-input>
                                        </el-col>
                                        <el-col :span="4">
                                            <el-button type="danger" @click="removeSeparatorPattern(index)">
                                                删除
                                            </el-button>
                                        </el-col>
                                    </el-row>
                                </div>
                                
                                <el-button @click="addSeparatorPattern" class="mt-2">
                                    + 添加分隔符模式
                                </el-button>
                            </div>
                            
                            <el-divider></el-divider>
                            
                            <div class="help-text">
                                <h4>📝 常用分隔符示例</h4>
                                <ul>
                                    <li><code>━{10,}</code> - 连续10个或以上的横线</li>
                                    <li><code>═{10,}</code> - 连续10个或以上的双线</li>
                                    <li><code>─{10,}</code> - 连续10个或以上的细线</li>
                                    <li><code>\*{10,}</code> - 连续10个或以上的星号</li>
                                    <li><code>-{10,}</code> - 连续10个或以上的短横线</li>
                                </ul>
                            </div>
                        </el-card>
                    </div>
                </el-tab-pane>
                
                <!-- 训练历史 -->
                <el-tab-pane label="📊 训练历史" name="history" v-if="trainingMode === 'tail'">
                    <div class="config-section">
                        <el-table :data="trainingHistory" stripe border class="data-table">
                            <el-table-column prop="channel_name" label="频道名称" width="300"></el-table-column>
                            <el-table-column prop="tail_length" label="过滤字符数" width="150">
                                <template #default="scope">
                                    <el-tag type="info">{{ scope.row.tail_length }} 字符</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="created_at" label="训练时间">
                                <template #default="scope">
                                    {{ formatTime(scope.row.created_at) }}
                                </template>
                            </el-table-column>
                            <el-table-column label="操作" width="100">
                                <template #default="scope">
                                    <el-button type="danger" size="small" @click="deleteTraining(scope.row.id)">
                                        删除
                                    </el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                        
                        <div v-if="trainingHistory.length === 0" class="empty-message">
                            暂无训练记录
                        </div>
                    </div>
                </el-tab-pane>

                <!-- 使用说明 -->
                <el-tab-pane label="📖 使用说明" name="help">
                    <div class="config-section">
                        <el-card>
                            <h3>🎯 AI训练使用指南</h3>
                            
                            <el-divider></el-divider>
                            
                            <h4>1. 手动训练步骤</h4>
                            <ol>
                                <li>复制包含推广内容的完整消息</li>
                                <li>粘贴到"原始消息内容"框中</li>
                                <li>将需要过滤的尾部内容（如订阅链接、投稿信息等）粘贴到"推广尾部内容"框中</li>
                                <li>查看预览效果，确认过滤是否正确</li>
                                <li>点击"提交训练样本"保存</li>
                                <li>重复多次以增加训练效果（建议至少5-10个样本）</li>
                            </ol>
                            
                            <el-divider></el-divider>
                            
                            <h4>2. 自动应用</h4>
                            <ul>
                                <li>提交训练样本后，AI会立即学习并应用</li>
                                <li>训练后的模型会自动应用到新消息的过滤中</li>
                                <li>结合规则过滤，提供双重保障</li>
                            </ul>
                            
                            <el-divider></el-divider>
                            
                            <h4>3. 常见推广格式示例</h4>
                            <pre class="example-box">
👌订阅频道：@channel_name
👌投稿爆料：@contact_user
👌海外交友：@dating_channel

📢 订阅新闻频道
📣 商务合作 @business
🔗 更多精彩 t.me/xxx
                            </pre>
                            
                            <el-divider></el-divider>
                            
                            <h4>4. 注意事项</h4>
                            <ul>
                                <li>训练数据会永久保存在数据库中</li>
                                <li>每个频道的推广格式可能不同，需要分别训练</li>
                                <li>训练样本越多，AI识别越准确</li>
                                <li>可以随时查看和删除训练历史</li>
                            </ul>
                        </el-card>
                    </div>
                </el-tab-pane>
            </el-tabs>
            
            <!-- 数据管理界面 (独立于标签页) -->
            <div v-if="trainingMode === 'data'" class="config-section">
                <div class="table-card">
                    <div class="table-header">
                        <div class="flex-between">
                            <div>
                                <h3 class="table-title">📁 训练数据管理中心</h3>
                                <p class="text-secondary">
                                    统一管理所有类型的训练数据，包括尾部过滤、广告检测等
                                </p>
                            </div>
                            <el-button type="primary" class="btn-primary" @click="openTrainingManager">
                                <el-icon><Setting /></el-icon>
                                打开管理界面
                            </el-button>
                        </div>
                    </div>

                    <el-divider></el-divider>

                    <!-- 统计信息栏 -->
                    <div class="stats-section compact">
                        <div class="stats-inline">
                            <div class="stat-item-inline">
                                <span class="stat-label">训练样本总数:</span>
                                <span class="stat-value">{{ trainingDataStats.totalSamples || 0 }}</span>
                            </div>
                            <div class="stat-item-inline">
                                <span class="stat-label">独特样本数:</span>
                                <span class="stat-value">{{ trainingDataStats.uniqueSamples || 0 }}</span>
                            </div>
                            <div class="stat-item-inline">
                                <span class="stat-label">媒体文件数:</span>
                                <span class="stat-value">{{ trainingDataStats.mediaFiles || 0 }}</span>
                            </div>
                            <div class="stat-item-inline">
                                <span class="stat-label">存储空间:</span>
                                <span class="stat-value">{{ formatSize(trainingDataStats.storageSize || 0) }}</span>
                            </div>
                        </div>
                    </div>

                    <el-divider></el-divider>

                    <h4 class="section-title">🛠️ 数据类型</h4>
                    <div class="data-type-section">
                        <div class="data-type-grid">
                            <div class="data-type-card">
                                <div class="data-type-header">
                                    <div class="data-type-icon">📏</div>
                                    <h5>尾部过滤数据</h5>
                                </div>
                                <p class="data-type-desc">管理频道尾部推广内容的训练样本</p>
                                <el-button size="small" type="primary" class="btn-primary" @click="openTrainingManager('tail')">
                                    管理尾部数据
                                </el-button>
                            </div>
                            <div class="data-type-card">
                                <div class="data-type-header">
                                    <div class="data-type-icon">🚫</div>
                                    <h5>广告检测数据</h5>
                                </div>
                                <p class="data-type-desc">管理广告内容识别的训练样本</p>
                                <el-button size="small" type="primary" class="btn-primary" @click="openTrainingManager('ad')">
                                    管理广告数据
                                </el-button>
                            </div>
                        </div>
                    </div>

                    <el-divider></el-divider>

                    <h4 class="section-title">🔧 管理功能</h4>
                    <div class="feature-list">
                        <div class="feature-item">
                            <div class="feature-icon">🔍</div>
                            <div class="feature-content">
                                <h5>查看样本</h5>
                                <p>浏览所有训练数据，支持搜索和筛选</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">❌</div>
                            <div class="feature-content">
                                <h5>删除误判</h5>
                                <p>移除被错误标记的样本</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">✅</div>
                            <div class="feature-content">
                                <h5>批量操作</h5>
                                <p>选择多个样本进行批量删除</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">🔄</div>
                            <div class="feature-content">
                                <h5>重复检测</h5>
                                <p>自动检测相似或重复的样本（85%相似度阈值）</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">♾️</div>
                            <div class="feature-content">
                                <h5>存储优化</h5>
                                <p>将视频转换为快照，节省95%存储空间</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">🔁</div>
                            <div class="feature-content">
                                <h5>模型重载</h5>
                                <p>更新后立即重新加载训练模型</p>
                            </div>
                        </div>
                    </div>

                    <el-alert type="warning" class="warning-alert" :closable="false">
                        <template #title>
                            <strong>⚠️ 注意事项</strong>
                        </template>
                        <div class="alert-content">
                            <div class="alert-item">⚠️ 删除操作不可恢复，请谨慎操作</div>
                            <div class="alert-item">🔍 去重前建议先查看重复检测结果</div>
                            <div class="alert-item">📹 存储优化会将视频文件转换为图片快照</div>
                            <div class="alert-item">⚙️ 模型重载会短暂影响检测服务</div>
                            <div class="alert-item">💾 定期备份重要训练数据</div>
                        </div>
                    </el-alert>
                </div>
            </div>
        </div>
        
        <!-- 底部加载指示器 -->
        <div v-if="loading" class="loading-overlay">
            <el-icon class="is-loading"><Loading /></el-icon>
            <span>{{ loadingText }}</span>
        </div>
    </div>

    <script src="assets/js/vue.prod.js?v=3"></script>
    <script src="assets/js/element-plus.js"></script>
    <script src="assets/js/axios.js?v=3"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/components/navbar.js"></script>
    <script src="assets/js/components/training-nav.js"></script>
    <script src="assets/js/components/train.js?v=1"></script>
    
    <style>
        .pattern-item {
            margin-bottom: 10px;
        }
        
        .separator-patterns {
            padding: 10px 0;
        }
        
        .help-text {
            background-color: #f5f7fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .help-text h4 {
            margin-top: 0;
            color: #409EFF;
        }
        
        .help-text ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .help-text code {
            background-color: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            color: #e6a23c;
        }
    </style>
    
</body>
</html>