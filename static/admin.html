<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统管理 - Telegram消息审核系统</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .config-section {
            margin: 20px 0;
        }
        .status-healthy {
            color: #67C23A;
        }
        .status-unhealthy {
            color: #F56C6C;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>⚙️ 系统管理</h1>
            <p>配置管理 · 系统监控 · 规则设置</p>
        </div>

        <el-container style="padding: 20px;">
            <!-- 系统状态 -->
            <el-card class="config-section">
                <template #header>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>系统状态</span>
                        <el-button @click="checkHealth" icon="Refresh" size="small">刷新</el-button>
                    </div>
                </template>
                
                <el-descriptions :column="3" border>
                    <el-descriptions-item label="系统状态">
                        <span :class="health.status === 'healthy' ? 'status-healthy' : 'status-unhealthy'">
                            {{ health.status === 'healthy' ? '✅ 正常' : '❌ 异常' }}
                        </span>
                    </el-descriptions-item>
                    <el-descriptions-item label="数据库">
                        <span :class="health.database === 'connected' ? 'status-healthy' : 'status-unhealthy'">
                            {{ health.database === 'connected' ? '✅ 已连接' : '❌ 断开' }}
                        </span>
                    </el-descriptions-item>
                    <el-descriptions-item label="版本">{{ health.version || 'N/A' }}</el-descriptions-item>
                    <el-descriptions-item label="最后检查" span="3">{{ health.timestamp || 'N/A' }}</el-descriptions-item>
                </el-descriptions>
            </el-card>

            <!-- 频道管理 -->
            <el-card class="config-section">
                <template #header>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>频道管理</span>
                        <el-button @click="showAddChannelDialog = true" type="primary" icon="Plus">添加频道</el-button>
                    </div>
                </template>
                
                <el-table :data="channels" style="width: 100%">
                    <el-table-column prop="channel_name" label="频道名称" width="200"></el-table-column>
                    <el-table-column prop="channel_id" label="频道ID" width="200"></el-table-column>
                    <el-table-column prop="channel_type" label="类型" width="120">
                        <template #default="scope">
                            <el-tag :type="getChannelTypeColor(scope.row.channel_type)">
                                {{ getChannelTypeText(scope.row.channel_type) }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="is_active" label="状态" width="100">
                        <template #default="scope">
                            <el-tag :type="scope.row.is_active ? 'success' : 'danger'">
                                {{ scope.row.is_active ? '启用' : '禁用' }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="created_at" label="创建时间">
                        <template #default="scope">
                            {{ formatTime(scope.row.created_at) }}
                        </template>
                    </el-table-column>
                </el-table>
            </el-card>

            <!-- 过滤规则管理 -->
            <el-card class="config-section">
                <template #header>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>过滤规则</span>
                        <el-button @click="showAddRuleDialog = true" type="primary" icon="Plus">添加规则</el-button>
                    </div>
                </template>
                
                <el-table :data="filterRules" style="width: 100%">
                    <el-table-column prop="rule_type" label="类型" width="120">
                        <template #default="scope">
                            <el-tag :type="scope.row.rule_type === 'keyword' ? 'primary' : 'warning'">
                                {{ scope.row.rule_type === 'keyword' ? '关键词' : '正则' }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="pattern" label="匹配模式" width="300"></el-table-column>
                    <el-table-column prop="action" label="动作" width="120">
                        <template #default="scope">
                            <el-tag :type="getActionColor(scope.row.action)">
                                {{ getActionText(scope.row.action) }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="is_active" label="状态" width="100">
                        <template #default="scope">
                            <el-tag :type="scope.row.is_active ? 'success' : 'danger'">
                                {{ scope.row.is_active ? '启用' : '禁用' }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="created_at" label="创建时间">
                        <template #default="scope">
                            {{ formatTime(scope.row.created_at) }}
                        </template>
                    </el-table-column>
                </el-table>
            </el-card>

            <!-- 系统配置 -->
            <el-card class="config-section">
                <template #header>
                    <span>系统配置</span>
                </template>
                
                <el-descriptions :column="2" border>
                    <el-descriptions-item label="自动转发延迟">{{ config.auto_forward_delay }} 秒</el-descriptions-item>
                    <el-descriptions-item label="源频道数量">{{ config.source_channels?.length || 0 }}</el-descriptions-item>
                    <el-descriptions-item label="审核群ID">{{ config.review_group_id }}</el-descriptions-item>
                    <el-descriptions-item label="目标频道ID">{{ config.target_channel_id }}</el-descriptions-item>
                    <el-descriptions-item label="广告关键词" span="2">
                        <el-tag v-for="keyword in config.ad_keywords" :key="keyword" style="margin: 2px;">
                            {{ keyword }}
                        </el-tag>
                    </el-descriptions-item>
                </el-descriptions>
            </el-card>
        </el-container>

        <!-- 添加频道对话框 -->
        <el-dialog v-model="showAddChannelDialog" title="添加频道" width="500px">
            <el-form :model="newChannel" label-width="100px">
                <el-form-item label="频道ID">
                    <el-input v-model="newChannel.channel_id" placeholder="@channel_name 或 -1001234567890"></el-input>
                </el-form-item>
                <el-form-item label="频道名称">
                    <el-input v-model="newChannel.channel_name" placeholder="输入频道名称"></el-input>
                </el-form-item>
                <el-form-item label="频道类型">
                    <el-select v-model="newChannel.channel_type" placeholder="选择类型">
                        <el-option label="源频道" value="source"></el-option>
                        <el-option label="审核群" value="review"></el-option>
                        <el-option label="目标频道" value="target"></el-option>
                    </el-select>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="showAddChannelDialog = false">取消</el-button>
                <el-button type="primary" @click="addChannel">确定</el-button>
            </template>
        </el-dialog>

        <!-- 添加规则对话框 -->
        <el-dialog v-model="showAddRuleDialog" title="添加过滤规则" width="500px">
            <el-form :model="newRule" label-width="100px">
                <el-form-item label="规则类型">
                    <el-select v-model="newRule.rule_type" placeholder="选择类型">
                        <el-option label="关键词" value="keyword"></el-option>
                        <el-option label="正则表达式" value="regex"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="匹配模式">
                    <el-input v-model="newRule.pattern" placeholder="输入关键词或正则表达式"></el-input>
                </el-form-item>
                <el-form-item label="执行动作">
                    <el-select v-model="newRule.action" placeholder="选择动作">
                        <el-option label="标记" value="flag"></el-option>
                        <el-option label="阻止" value="block"></el-option>
                        <el-option label="替换" value="replace"></el-option>
                    </el-select>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="showAddRuleDialog = false">取消</el-button>
                <el-button type="primary" @click="addRule">确定</el-button>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage } = ElementPlus;

        createApp({
            data() {
                return {
                    health: {},
                    channels: [],
                    filterRules: [],
                    config: {},
                    showAddChannelDialog: false,
                    showAddRuleDialog: false,
                    newChannel: {
                        channel_id: '',
                        channel_name: '',
                        channel_type: 'source'
                    },
                    newRule: {
                        rule_type: 'keyword',
                        pattern: '',
                        action: 'flag'
                    }
                }
            },
            mounted() {
                this.loadData();
            },
            methods: {
                async loadData() {
                    await Promise.all([
                        this.checkHealth(),
                        this.loadChannels(),
                        this.loadFilterRules(),
                        this.loadConfig()
                    ]);
                },
                
                async checkHealth() {
                    try {
                        const response = await axios.get('/api/admin/health');
                        this.health = response.data;
                    } catch (error) {
                        ElMessage.error('获取系统状态失败');
                    }
                },
                
                async loadChannels() {
                    try {
                        const response = await axios.get('/api/admin/channels');
                        this.channels = response.data.channels;
                    } catch (error) {
                        ElMessage.error('加载频道列表失败');
                    }
                },
                
                async loadFilterRules() {
                    try {
                        const response = await axios.get('/api/admin/filter-rules');
                        this.filterRules = response.data.rules;
                    } catch (error) {
                        ElMessage.error('加载过滤规则失败');
                    }
                },
                
                async loadConfig() {
                    try {
                        const response = await axios.get('/api/admin/config');
                        this.config = response.data;
                    } catch (error) {
                        ElMessage.error('加载系统配置失败');
                    }
                },
                
                async addChannel() {
                    try {
                        await axios.post('/api/admin/channels', this.newChannel);
                        ElMessage.success('频道添加成功');
                        this.showAddChannelDialog = false;
                        this.newChannel = { channel_id: '', channel_name: '', channel_type: 'source' };
                        this.loadChannels();
                    } catch (error) {
                        ElMessage.error('添加频道失败');
                    }
                },
                
                async addRule() {
                    try {
                        await axios.post('/api/admin/filter-rules', this.newRule);
                        ElMessage.success('过滤规则添加成功');
                        this.showAddRuleDialog = false;
                        this.newRule = { rule_type: 'keyword', pattern: '', action: 'flag' };
                        this.loadFilterRules();
                    } catch (error) {
                        ElMessage.error('添加过滤规则失败');
                    }
                },
                
                getChannelTypeColor(type) {
                    const colors = {
                        source: 'primary',
                        review: 'warning',
                        target: 'success'
                    };
                    return colors[type] || 'info';
                },
                
                getChannelTypeText(type) {
                    const texts = {
                        source: '源频道',
                        review: '审核群',
                        target: '目标频道'
                    };
                    return texts[type] || type;
                },
                
                getActionColor(action) {
                    const colors = {
                        flag: 'warning',
                        block: 'danger',
                        replace: 'primary'
                    };
                    return colors[action] || 'info';
                },
                
                getActionText(action) {
                    const texts = {
                        flag: '标记',
                        block: '阻止',
                        replace: '替换'
                    };
                    return texts[action] || action;
                },
                
                formatTime(timeStr) {
                    return new Date(timeStr).toLocaleString('zh-CN');
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>