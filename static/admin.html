<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统管理 - 星际争霸风格</title>
    <link rel="stylesheet" href="assets/css/element-plus.css">
    <link rel="stylesheet" href="assets/css/starcraft.css">
    <script src="assets/js/vue.js"></script>
    <script src="assets/js/element-plus.js"></script>
    <script src="assets/js/axios.js"></script>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>⚙️ 系统管理控制台</h1>
            <p>配置管理 · 系统监控 · 规则设置</p>
        </div>

        <!-- 导航栏 -->
        <div class="nav-bar">
            <div class="nav-links">
                <a href="/" class="nav-link">🏠 主控制台</a>
                <a href="/config" class="nav-link">⚙️ 系统配置</a>
                <a href="/status" class="nav-link">📊 系统状态</a>
                <a href="/auth" class="nav-link">🔐 Telegram登录</a>
                <a href="/admin" class="nav-link active">🔧 系统管理</a>
            </div>
            <div class="nav-links">
                <span style="color: #7fdbff; font-weight: 700;">管理状态: {{ adminStatus }}</span>
            </div>
        </div>

        <div class="container">
            <!-- 系统状态 -->
            <div class="card">
                <div class="card-header">
                    <h2>🔍 系统状态</h2>
                </div>
                <div class="card-content">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number">{{ health.status === 'healthy' ? '✅' : '❌' }}</div>
                            <div class="stat-label">系统状态</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">{{ health.database === 'connected' ? '✅' : '❌' }}</div>
                            <div class="stat-label">数据库</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">{{ health.version || 'N/A' }}</div>
                            <div class="stat-label">版本</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <el-button @click="checkHealth" type="primary" icon="Refresh">
                            刷新状态
                        </el-button>
                    </div>
                </div>
            </div>

            <!-- 频道管理 -->
            <div class="card">
                <div class="card-header">
                    <h2>📺 频道管理</h2>
                </div>
                <div class="card-content">
                    <div style="margin-bottom: 20px;">
                        <el-button @click="showAddChannelDialog = true" type="primary" icon="Plus">
                            添加频道
                        </el-button>
                    </div>
                    
                    <div class="list-item" v-for="channel in channels" :key="channel.id">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="list-item-title">{{ channel.channel_name }}</div>
                                <div class="list-item-subtitle">{{ channel.channel_id }}</div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <el-tag :type="getChannelTypeColor(channel.channel_type)">
                                    {{ getChannelTypeText(channel.channel_type) }}
                                </el-tag>
                                <el-tag :type="channel.is_active ? 'success' : 'danger'">
                                    {{ channel.is_active ? '启用' : '禁用' }}
                                </el-tag>
                                <el-button @click="editChannel(channel)" type="info" size="small">
                                    编辑
                                </el-button>
                                <el-button @click="deleteChannel(channel.id)" type="danger" size="small">
                                    删除
                                </el-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 过滤规则管理 -->
            <div class="card">
                <div class="card-header">
                    <h2>🔍 过滤规则</h2>
                </div>
                <div class="card-content">
                    <div style="margin-bottom: 20px;">
                        <el-button @click="showAddRuleDialog = true" type="primary" icon="Plus">
                            添加规则
                        </el-button>
                    </div>
                    
                    <div class="list-item" v-for="rule in filterRules" :key="rule.id">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="list-item-title">{{ rule.pattern }}</div>
                                <div class="list-item-subtitle">{{ rule.description }}</div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <el-tag :type="rule.rule_type === 'keyword' ? 'primary' : 'warning'">
                                    {{ rule.rule_type }}
                                </el-tag>
                                <el-tag :type="rule.is_active ? 'success' : 'danger'">
                                    {{ rule.is_active ? '启用' : '禁用' }}
                                </el-tag>
                                <el-button @click="editRule(rule)" type="info" size="small">
                                    编辑
                                </el-button>
                                <el-button @click="deleteRule(rule.id)" type="danger" size="small">
                                    删除
                                </el-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 系统操作 -->
            <div class="card">
                <div class="card-header">
                    <h2>⚡ 系统操作</h2>
                </div>
                <div class="card-content">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <el-button @click="restartSystem" type="warning" icon="Refresh">
                            重启系统
                        </el-button>
                        <el-button @click="backupData" type="info" icon="Download">
                            备份数据
                        </el-button>
                        <el-button @click="clearCache" type="danger" icon="Delete">
                            清理缓存
                        </el-button>
                        <el-button @click="exportLogs" type="primary" icon="Document">
                            导出日志
                        </el-button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 状态消息 -->
        <div v-if="statusMessage" class="status-message" :class="statusType">
            {{ statusMessage }}
        </div>
        
        <!-- 加载遮罩 -->
        <div v-if="loading" class="loading-overlay">
            <div class="loading-content">
                <el-icon class="is-loading">
                    <Loading />
                </el-icon>
                <p style="margin-top: 15px; color: #00ff41;">{{ loadingMessage }}</p>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage } = ElementPlus;

        createApp({
            data() {
                return {
                    loading: false,
                    loadingMessage: '',
                    statusMessage: '',
                    statusType: 'success',
                    adminStatus: '在线',
                    health: {
                        status: 'healthy',
                        database: 'connected',
                        version: 'v1.0.0',
                        timestamp: new Date().toLocaleString()
                    },
                    channels: [],
                    filterRules: [],
                    showAddChannelDialog: false,
                    showAddRuleDialog: false
                }
            },
            
            mounted() {
                this.loadAdminData();
            },
            
            methods: {
                async loadAdminData() {
                    this.loading = true;
                    this.loadingMessage = '正在加载管理数据...';
                    
                    try {
                        // 加载健康状态
                        await this.checkHealth();
                        
                        // 加载频道列表
                        const channelsResponse = await axios.get('/api/admin/channels');
                        if (channelsResponse.data.success) {
                            this.channels = channelsResponse.data.channels;
                        }
                        
                        // 加载过滤规则
                        const rulesResponse = await axios.get('/api/admin/filter-rules');
                        if (rulesResponse.data.success) {
                            this.filterRules = rulesResponse.data.rules;
                        }
                        
                    } catch (error) {
                        console.error('加载管理数据失败:', error);
                        this.loadMockData();
                    } finally {
                        this.loading = false;
                    }
                },
                
                loadMockData() {
                    // 模拟数据
                    this.channels = [
                        { id: 1, channel_name: '测试频道1', channel_id: '@test1', channel_type: 'source', is_active: true },
                        { id: 2, channel_name: '测试频道2', channel_id: '@test2', channel_type: 'source', is_active: false }
                    ];
                    
                    this.filterRules = [
                        { id: 1, pattern: '广告', rule_type: 'keyword', is_active: true, description: '过滤广告内容' },
                        { id: 2, pattern: '推广', rule_type: 'keyword', is_active: true, description: '过滤推广内容' }
                    ];
                },
                
                async checkHealth() {
                    try {
                        const response = await axios.get('/api/admin/health');
                        if (response.data.success) {
                            this.health = response.data.health;
                        }
                    } catch (error) {
                        console.error('检查健康状态失败:', error);
                    }
                },
                
                getChannelTypeColor(type) {
                    const colors = {
                        'source': 'primary',
                        'target': 'success',
                        'review': 'warning'
                    };
                    return colors[type] || 'info';
                },
                
                getChannelTypeText(type) {
                    const texts = {
                        'source': '源频道',
                        'target': '目标频道',
                        'review': '审核频道'
                    };
                    return texts[type] || type;
                },
                
                async editChannel(channel) {
                    try {
                        // 这里可以实现编辑频道的弹窗或跳转到编辑页面
                        // 暂时显示频道信息
                        this.showSuccess(`编辑频道: ${channel.channel_name} (${channel.channel_id})`);
                        
                        // 可以添加编辑逻辑，比如打开编辑弹窗
                        // this.editDialogVisible = true;
                        // this.editingChannel = channel;
                    } catch (error) {
                        this.showError('编辑频道失败: ' + error.message);
                    }
                },
                
                async deleteChannel(channelId) {
                    try {
                        if (confirm('确定要删除这个频道吗？')) {
                            const response = await axios.delete(`/api/admin/channels/${channelId}`);
                            if (response.data.message) {
                                this.showSuccess(response.data.message);
                                // 重新加载频道列表
                                await this.loadChannels();
                            }
                        }
                    } catch (error) {
                        this.showError('删除频道失败: ' + (error.response?.data?.detail || error.message));
                    }
                },
                
                async editRule(rule) {
                    try {
                        // 这里可以实现编辑规则的弹窗或跳转到编辑页面
                        this.showSuccess(`编辑规则: ${rule.pattern} (${rule.rule_type})`);
                        
                        // 可以添加编辑逻辑，比如打开编辑弹窗
                        // this.editRuleDialogVisible = true;
                        // this.editingRule = rule;
                    } catch (error) {
                        this.showError('编辑规则失败: ' + error.message);
                    }
                },
                
                async deleteRule(ruleId) {
                    try {
                        if (confirm('确定要删除这个过滤规则吗？')) {
                            const response = await axios.delete(`/api/admin/filter-rules/${ruleId}`);
                            if (response.data.message) {
                                this.showSuccess(response.data.message);
                                // 重新加载规则列表
                                await this.loadFilterRules();
                            }
                        }
                    } catch (error) {
                        this.showError('删除规则失败: ' + (error.response?.data?.detail || error.message));
                    }
                },
                
                async restartSystem() {
                    try {
                        const response = await axios.post('/api/admin/restart');
                        if (response.data.success) {
                            this.showSuccess('系统重启成功');
                        } else {
                            this.showError('系统重启失败');
                        }
                    } catch (error) {
                        this.showError('系统重启失败: ' + (error.response?.data?.detail || error.message));
                    }
                },
                
                async backupData() {
                    try {
                        const response = await axios.post('/api/admin/backup');
                        if (response.data.success) {
                            this.showSuccess('数据备份成功');
                        } else {
                            this.showError('数据备份失败');
                        }
                    } catch (error) {
                        this.showError('数据备份失败: ' + (error.response?.data?.detail || error.message));
                    }
                },
                
                async clearCache() {
                    try {
                        const response = await axios.post('/api/admin/clear-cache');
                        if (response.data.success) {
                            this.showSuccess('缓存清理成功');
                        } else {
                            this.showError('缓存清理失败');
                        }
                    } catch (error) {
                        this.showError('缓存清理失败: ' + (error.response?.data?.detail || error.message));
                    }
                },
                
                async exportLogs() {
                    try {
                        const response = await axios.post('/api/admin/export-logs');
                        if (response.data.success) {
                            this.showSuccess('日志导出成功');
                        } else {
                            this.showError('日志导出失败');
                        }
                    } catch (error) {
                        this.showError('日志导出失败: ' + (error.response?.data?.detail || error.message));
                    }
                },
                
                showSuccess(message) {
                    this.statusMessage = message;
                    this.statusType = 'success';
                    setTimeout(() => {
                        this.statusMessage = '';
                    }, 3000);
                },
                
                showError(message) {
                    this.statusMessage = message;
                    this.statusType = 'error';
                    setTimeout(() => {
                        this.statusMessage = '';
                    }, 5000);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>