<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿç®¡ç† - æ˜Ÿé™…äº‰éœ¸é£æ ¼</title>
    <link rel="stylesheet" href="assets/css/element-plus.css">
    <link rel="stylesheet" href="assets/css/starcraft.css">
    <script src="assets/js/vue.js"></script>
    <script src="assets/js/element-plus.js"></script>
    <script src="assets/js/axios.js"></script>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>âš™ï¸ ç³»ç»Ÿç®¡ç†æ§åˆ¶å°</h1>
            <p>é…ç½®ç®¡ç† Â· ç³»ç»Ÿç›‘æ§ Â· è§„åˆ™è®¾ç½®</p>
        </div>

        <!-- å¯¼èˆªæ  -->
        <div class="nav-bar">
            <div class="nav-links">
                <a href="/" class="nav-link">ğŸ  ä¸»æ§åˆ¶å°</a>
                <a href="/config" class="nav-link">âš™ï¸ ç³»ç»Ÿé…ç½®</a>
                <a href="/status" class="nav-link">ğŸ“Š ç³»ç»ŸçŠ¶æ€</a>
                <a href="/auth" class="nav-link">ğŸ” Telegramç™»å½•</a>
                <a href="/admin" class="nav-link active">ğŸ”§ ç³»ç»Ÿç®¡ç†</a>
            </div>
            <div class="nav-links">
                <span style="color: #7fdbff; font-weight: 700;">ç®¡ç†çŠ¶æ€: {{ adminStatus }}</span>
            </div>
        </div>

        <div class="container">
            <!-- ç³»ç»ŸçŠ¶æ€ -->
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ” ç³»ç»ŸçŠ¶æ€</h2>
                </div>
                <div class="card-content">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number">{{ health.status === 'healthy' ? 'âœ…' : 'âŒ' }}</div>
                            <div class="stat-label">ç³»ç»ŸçŠ¶æ€</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">{{ health.database === 'connected' ? 'âœ…' : 'âŒ' }}</div>
                            <div class="stat-label">æ•°æ®åº“</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">{{ health.version || 'N/A' }}</div>
                            <div class="stat-label">ç‰ˆæœ¬</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <el-button @click="checkHealth" type="primary" icon="Refresh">
                            åˆ·æ–°çŠ¶æ€
                        </el-button>
                    </div>
                </div>
            </div>

            <!-- é¢‘é“ç®¡ç† -->
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ“º é¢‘é“ç®¡ç†</h2>
                </div>
                <div class="card-content">
                    <div style="margin-bottom: 20px;">
                        <el-button @click="showAddChannelDialog = true" type="primary" icon="Plus">
                            æ·»åŠ é¢‘é“
                        </el-button>
                    </div>
                    
                    <div class="list-item" v-for="channel in channels" :key="channel.id">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="list-item-title">{{ channel.channel_name }}</div>
                                <div class="list-item-subtitle">{{ channel.channel_id }}</div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <el-tag :type="getChannelTypeColor(channel.channel_type)">
                                    {{ getChannelTypeText(channel.channel_type) }}
                                </el-tag>
                                <el-tag :type="channel.is_active ? 'success' : 'danger'">
                                    {{ channel.is_active ? 'å¯ç”¨' : 'ç¦ç”¨' }}
                                </el-tag>
                                <el-button @click="editChannel(channel)" type="info" size="small">
                                    ç¼–è¾‘
                                </el-button>
                                <el-button @click="deleteChannel(channel.id)" type="danger" size="small">
                                    åˆ é™¤
                                </el-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¿‡æ»¤è§„åˆ™ç®¡ç† -->
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ” è¿‡æ»¤è§„åˆ™</h2>
                </div>
                <div class="card-content">
                    <div style="margin-bottom: 20px;">
                        <el-button @click="showAddRuleDialog = true" type="primary" icon="Plus">
                            æ·»åŠ è§„åˆ™
                        </el-button>
                    </div>
                    
                    <div class="list-item" v-for="rule in filterRules" :key="rule.id">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="list-item-title">{{ rule.pattern }}</div>
                                <div class="list-item-subtitle">{{ rule.description }}</div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <el-tag :type="rule.rule_type === 'keyword' ? 'primary' : 'warning'">
                                    {{ rule.rule_type }}
                                </el-tag>
                                <el-tag :type="rule.is_active ? 'success' : 'danger'">
                                    {{ rule.is_active ? 'å¯ç”¨' : 'ç¦ç”¨' }}
                                </el-tag>
                                <el-button @click="editRule(rule)" type="info" size="small">
                                    ç¼–è¾‘
                                </el-button>
                                <el-button @click="deleteRule(rule.id)" type="danger" size="small">
                                    åˆ é™¤
                                </el-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç³»ç»Ÿæ“ä½œ -->
            <div class="card">
                <div class="card-header">
                    <h2>âš¡ ç³»ç»Ÿæ“ä½œ</h2>
                </div>
                <div class="card-content">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <el-button @click="restartSystem" type="warning" icon="Refresh">
                            é‡å¯ç³»ç»Ÿ
                        </el-button>
                        <el-button @click="backupData" type="info" icon="Download">
                            å¤‡ä»½æ•°æ®
                        </el-button>
                        <el-button @click="clearCache" type="danger" icon="Delete">
                            æ¸…ç†ç¼“å­˜
                        </el-button>
                        <el-button @click="exportLogs" type="primary" icon="Document">
                            å¯¼å‡ºæ—¥å¿—
                        </el-button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- çŠ¶æ€æ¶ˆæ¯ -->
        <div v-if="statusMessage" class="status-message" :class="statusType">
            {{ statusMessage }}
        </div>
        
        <!-- åŠ è½½é®ç½© -->
        <div v-if="loading" class="loading-overlay">
            <div class="loading-content">
                <el-icon class="is-loading">
                    <Loading />
                </el-icon>
                <p style="margin-top: 15px; color: #00ff41;">{{ loadingMessage }}</p>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage } = ElementPlus;

        createApp({
            data() {
                return {
                    loading: false,
                    loadingMessage: '',
                    statusMessage: '',
                    statusType: 'success',
                    adminStatus: 'åœ¨çº¿',
                    health: {
                        status: 'healthy',
                        database: 'connected',
                        version: 'v1.0.0',
                        timestamp: new Date().toLocaleString()
                    },
                    channels: [],
                    filterRules: [],
                    showAddChannelDialog: false,
                    showAddRuleDialog: false
                }
            },
            
            mounted() {
                this.loadAdminData();
            },
            
            methods: {
                async loadAdminData() {
                    this.loading = true;
                    this.loadingMessage = 'æ­£åœ¨åŠ è½½ç®¡ç†æ•°æ®...';
                    
                    try {
                        // åŠ è½½å¥åº·çŠ¶æ€
                        await this.checkHealth();
                        
                        // åŠ è½½é¢‘é“åˆ—è¡¨
                        const channelsResponse = await axios.get('/api/admin/channels');
                        if (channelsResponse.data.success) {
                            this.channels = channelsResponse.data.channels;
                        }
                        
                        // åŠ è½½è¿‡æ»¤è§„åˆ™
                        const rulesResponse = await axios.get('/api/admin/filter-rules');
                        if (rulesResponse.data.success) {
                            this.filterRules = rulesResponse.data.rules;
                        }
                        
                    } catch (error) {
                        console.error('åŠ è½½ç®¡ç†æ•°æ®å¤±è´¥:', error);
                        this.loadMockData();
                    } finally {
                        this.loading = false;
                    }
                },
                
                loadMockData() {
                    // æ¨¡æ‹Ÿæ•°æ®
                    this.channels = [
                        { id: 1, channel_name: 'æµ‹è¯•é¢‘é“1', channel_id: '@test1', channel_type: 'source', is_active: true },
                        { id: 2, channel_name: 'æµ‹è¯•é¢‘é“2', channel_id: '@test2', channel_type: 'source', is_active: false }
                    ];
                    
                    this.filterRules = [
                        { id: 1, pattern: 'å¹¿å‘Š', rule_type: 'keyword', is_active: true, description: 'è¿‡æ»¤å¹¿å‘Šå†…å®¹' },
                        { id: 2, pattern: 'æ¨å¹¿', rule_type: 'keyword', is_active: true, description: 'è¿‡æ»¤æ¨å¹¿å†…å®¹' }
                    ];
                },
                
                async checkHealth() {
                    try {
                        const response = await axios.get('/api/admin/health');
                        if (response.data.success) {
                            this.health = response.data.health;
                        }
                    } catch (error) {
                        console.error('æ£€æŸ¥å¥åº·çŠ¶æ€å¤±è´¥:', error);
                    }
                },
                
                getChannelTypeColor(type) {
                    const colors = {
                        'source': 'primary',
                        'target': 'success',
                        'review': 'warning'
                    };
                    return colors[type] || 'info';
                },
                
                getChannelTypeText(type) {
                    const texts = {
                        'source': 'æºé¢‘é“',
                        'target': 'ç›®æ ‡é¢‘é“',
                        'review': 'å®¡æ ¸é¢‘é“'
                    };
                    return texts[type] || type;
                },
                
                async editChannel(channel) {
                    try {
                        // è¿™é‡Œå¯ä»¥å®ç°ç¼–è¾‘é¢‘é“çš„å¼¹çª—æˆ–è·³è½¬åˆ°ç¼–è¾‘é¡µé¢
                        // æš‚æ—¶æ˜¾ç¤ºé¢‘é“ä¿¡æ¯
                        this.showSuccess(`ç¼–è¾‘é¢‘é“: ${channel.channel_name} (${channel.channel_id})`);
                        
                        // å¯ä»¥æ·»åŠ ç¼–è¾‘é€»è¾‘ï¼Œæ¯”å¦‚æ‰“å¼€ç¼–è¾‘å¼¹çª—
                        // this.editDialogVisible = true;
                        // this.editingChannel = channel;
                    } catch (error) {
                        this.showError('ç¼–è¾‘é¢‘é“å¤±è´¥: ' + error.message);
                    }
                },
                
                async deleteChannel(channelId) {
                    try {
                        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢‘é“å—ï¼Ÿ')) {
                            const response = await axios.delete(`/api/admin/channels/${channelId}`);
                            if (response.data.message) {
                                this.showSuccess(response.data.message);
                                // é‡æ–°åŠ è½½é¢‘é“åˆ—è¡¨
                                await this.loadChannels();
                            }
                        }
                    } catch (error) {
                        this.showError('åˆ é™¤é¢‘é“å¤±è´¥: ' + (error.response?.data?.detail || error.message));
                    }
                },
                
                async editRule(rule) {
                    try {
                        // è¿™é‡Œå¯ä»¥å®ç°ç¼–è¾‘è§„åˆ™çš„å¼¹çª—æˆ–è·³è½¬åˆ°ç¼–è¾‘é¡µé¢
                        this.showSuccess(`ç¼–è¾‘è§„åˆ™: ${rule.pattern} (${rule.rule_type})`);
                        
                        // å¯ä»¥æ·»åŠ ç¼–è¾‘é€»è¾‘ï¼Œæ¯”å¦‚æ‰“å¼€ç¼–è¾‘å¼¹çª—
                        // this.editRuleDialogVisible = true;
                        // this.editingRule = rule;
                    } catch (error) {
                        this.showError('ç¼–è¾‘è§„åˆ™å¤±è´¥: ' + error.message);
                    }
                },
                
                async deleteRule(ruleId) {
                    try {
                        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¿‡æ»¤è§„åˆ™å—ï¼Ÿ')) {
                            const response = await axios.delete(`/api/admin/filter-rules/${ruleId}`);
                            if (response.data.message) {
                                this.showSuccess(response.data.message);
                                // é‡æ–°åŠ è½½è§„åˆ™åˆ—è¡¨
                                await this.loadFilterRules();
                            }
                        }
                    } catch (error) {
                        this.showError('åˆ é™¤è§„åˆ™å¤±è´¥: ' + (error.response?.data?.detail || error.message));
                    }
                },
                
                async restartSystem() {
                    try {
                        const response = await axios.post('/api/admin/restart');
                        if (response.data.success) {
                            this.showSuccess('ç³»ç»Ÿé‡å¯æˆåŠŸ');
                        } else {
                            this.showError('ç³»ç»Ÿé‡å¯å¤±è´¥');
                        }
                    } catch (error) {
                        this.showError('ç³»ç»Ÿé‡å¯å¤±è´¥: ' + (error.response?.data?.detail || error.message));
                    }
                },
                
                async backupData() {
                    try {
                        const response = await axios.post('/api/admin/backup');
                        if (response.data.success) {
                            this.showSuccess('æ•°æ®å¤‡ä»½æˆåŠŸ');
                        } else {
                            this.showError('æ•°æ®å¤‡ä»½å¤±è´¥');
                        }
                    } catch (error) {
                        this.showError('æ•°æ®å¤‡ä»½å¤±è´¥: ' + (error.response?.data?.detail || error.message));
                    }
                },
                
                async clearCache() {
                    try {
                        const response = await axios.post('/api/admin/clear-cache');
                        if (response.data.success) {
                            this.showSuccess('ç¼“å­˜æ¸…ç†æˆåŠŸ');
                        } else {
                            this.showError('ç¼“å­˜æ¸…ç†å¤±è´¥');
                        }
                    } catch (error) {
                        this.showError('ç¼“å­˜æ¸…ç†å¤±è´¥: ' + (error.response?.data?.detail || error.message));
                    }
                },
                
                async exportLogs() {
                    try {
                        const response = await axios.post('/api/admin/export-logs');
                        if (response.data.success) {
                            this.showSuccess('æ—¥å¿—å¯¼å‡ºæˆåŠŸ');
                        } else {
                            this.showError('æ—¥å¿—å¯¼å‡ºå¤±è´¥');
                        }
                    } catch (error) {
                        this.showError('æ—¥å¿—å¯¼å‡ºå¤±è´¥: ' + (error.response?.data?.detail || error.message));
                    }
                },
                
                showSuccess(message) {
                    this.statusMessage = message;
                    this.statusType = 'success';
                    setTimeout(() => {
                        this.statusMessage = '';
                    }, 3000);
                },
                
                showError(message) {
                    this.statusMessage = message;
                    this.statusType = 'error';
                    setTimeout(() => {
                        this.statusMessage = '';
                    }, 5000);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>