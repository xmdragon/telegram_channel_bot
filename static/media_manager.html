<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â™í‰ΩìÊñá‰ª∂ÁÆ°ÁêÜ</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="assets/css/element-plus.css">
    <link rel="stylesheet" href="assets/css/element-plus-fixes.css">
    <link rel="stylesheet" href="assets/css/modern-ui.css">
    <link rel="stylesheet" href="assets/css/media-manager.css">
</head>
<body>
    <div id="app">
        <!-- ÂØºËà™Ê†è -->
        <nav-bar page-title="üñºÔ∏è Â™í‰ΩìÊñá‰ª∂ÁÆ°ÁêÜ" page-subtitle="ËÆ≠ÁªÉÊï∞ÊçÆÁöÑÂõæÁâáÂíåËßÜÈ¢ëÁÆ°ÁêÜ"></nav-bar>

        <div class="container">
            <!-- ÁªüËÆ°‰ø°ÊÅØ -->
            <div class="card">
                <div class="card-header">
                    <h2>üìä Â™í‰ΩìÁªüËÆ°</h2>
                </div>
                <div class="card-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">{{ stats.totalFiles }}</div>
                            <div class="stat-label">Êñá‰ª∂ÊÄªÊï∞</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">{{ stats.imageCount }}</div>
                            <div class="stat-label">ÂõæÁâá</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">{{ stats.videoCount }}</div>
                            <div class="stat-label">ËßÜÈ¢ë</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">{{ formatSize(stats.totalSize) }}</div>
                            <div class="stat-label">ÊÄªÂ§ßÂ∞è</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">{{ stats.referencedCount }}</div>
                            <div class="stat-label">Â∑≤ÂºïÁî®</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">{{ stats.orphanedCount }}</div>
                            <div class="stat-label">Êú™ÂºïÁî®</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Êìç‰ΩúÊåâÈíÆ -->
            <div class="card">
                <div class="card-header">
                    <h2>üîß ÊâπÈáèÊìç‰Ωú</h2>
                </div>
                <div class="card-content">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <el-button @click="loadMediaFiles" icon="Refresh">Âà∑Êñ∞ÂàóË°®</el-button>
                        <el-button @click="cleanOrphaned" type="warning" icon="Delete">Ê∏ÖÁêÜÊú™ÂºïÁî®Êñá‰ª∂</el-button>
                        <el-button @click="optimizeVideos" type="primary" icon="VideoCamera">‰ºòÂåñËßÜÈ¢ëÔºàËΩ¨Âø´ÁÖßÔºâ</el-button>
                        <el-button @click="downloadAll" type="success" icon="Download">ÂØºÂá∫ÊâÄÊúâÂ™í‰Ωì</el-button>
                    </div>
                </div>
            </div>

            <!-- Â™í‰ΩìÊñá‰ª∂ÂàóË°® -->
            <div class="card">
                <div class="card-header">
                    <h2>üìÅ Â™í‰ΩìÊñá‰ª∂</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <el-input v-model="searchKeyword" placeholder="ÊêúÁ¥¢Êñá‰ª∂Âêç" clearable style="width: 200px;">
                            <template #prefix>
                                <el-icon><Search /></el-icon>
                            </template>
                        </el-input>
                        <el-select v-model="filterType" placeholder="Á±ªÂûã" style="width: 120px;">
                            <el-option label="ÂÖ®ÈÉ®" value="all"></el-option>
                            <el-option label="ÂõæÁâá" value="image"></el-option>
                            <el-option label="ËßÜÈ¢ë" value="video"></el-option>
                            <el-option label="Â∑≤ÂºïÁî®" value="referenced"></el-option>
                            <el-option label="Êú™ÂºïÁî®" value="orphaned"></el-option>
                        </el-select>
                    </div>
                </div>
                <div class="card-content">
                    <div v-if="loading" style="text-align: center; padding: 50px;">
                        <el-icon class="is-loading" size="40">
                            <Loading />
                        </el-icon>
                        <p style="margin-top: 10px; color: #999;">Âä†ËΩΩ‰∏≠...</p>
                    </div>
                    
                    <div v-else-if="!filteredFiles.length" style="text-align: center; padding: 50px; color: #999;">
                        ÊöÇÊó†Â™í‰ΩìÊñá‰ª∂
                    </div>
                    
                    <div v-else class="media-grid">
                        <div v-for="file in paginatedFiles" :key="file.hash" class="media-card">
                            <el-image
                                v-if="file.type === 'image'"
                                :src="'/media/ad_training_data/' + file.path"
                                :preview-src-list="['/media/ad_training_data/' + file.path]"
                                fit="cover"
                                class="media-preview"
                                lazy
                            >
                                <template #error>
                                    <div style="display: flex; justify-content: center; align-items: center; height: 100%; background: #000;">
                                        <el-icon size="30" color="#666"><Picture /></el-icon>
                                    </div>
                                </template>
                            </el-image>
                            
                            <video v-else :src="'/media/ad_training_data/' + file.path" class="media-preview" preload="metadata" style="width: 100%; height: 200px; object-fit: cover;"></video>
                            
                            <div class="media-info">
                                <div class="media-name" :title="file.name">{{ file.name }}</div>
                                <div class="media-size">{{ formatSize(file.size) }}</div>
                                <div style="color: #666; margin-top: 5px;">
                                    ÂºïÁî®: {{ file.messageIds.length }} ‰∏™Ê†∑Êú¨
                                </div>
                            </div>
                            
                            <div class="media-actions">
                                <el-button size="small" @click="viewDetails(file)">ËØ¶ÊÉÖ</el-button>
                                <el-button size="small" type="danger" @click="deleteFile(file)">Âà†Èô§</el-button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÂàÜÈ°µ -->
                    <div v-if="filteredFiles.length > pageSize" style="margin-top: 20px; text-align: center;">
                        <el-pagination
                            v-model:current-page="currentPage"
                            :page-size="pageSize"
                            :total="filteredFiles.length"
                            layout="prev, pager, next, total"
                        />
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Êñá‰ª∂ËØ¶ÊÉÖÂØπËØùÊ°Ü -->
        <el-dialog v-model="detailDialog" title="Êñá‰ª∂ËØ¶ÊÉÖ" width="800px" class="file-details-dialog">
            <div v-if="currentFile">
                <el-descriptions :column="1" border>
                    <el-descriptions-item label="Êñá‰ª∂Âêç">{{ currentFile.name }}</el-descriptions-item>
                    <el-descriptions-item label="Ë∑ØÂæÑ">{{ currentFile.path }}</el-descriptions-item>
                    <el-descriptions-item label="Á±ªÂûã">{{ currentFile.type }}</el-descriptions-item>
                    <el-descriptions-item label="Â§ßÂ∞è">{{ formatSize(currentFile.size) }}</el-descriptions-item>
                    <el-descriptions-item label="ÂìàÂ∏å">{{ currentFile.hash }}</el-descriptions-item>
                    <el-descriptions-item label="ÂàõÂª∫Êó∂Èó¥">{{ currentFile.createdAt }}</el-descriptions-item>
                    <el-descriptions-item label="ÂºïÁî®Ê†∑Êú¨">
                        <el-tag v-for="id in currentFile.messageIds" :key="id" style="margin-right: 5px;">
                            #{{ id }}
                        </el-tag>
                    </el-descriptions-item>
                </el-descriptions>
                
                <div class="dialog-footer">
                    <el-image
                        v-if="currentFile.type === 'image'"
                        :src="'/media/ad_training_data/' + currentFile.path"
                        class="dialog-image"
                        fit="contain"
                    />
                </div>
            </div>
        </el-dialog>
    </div>

    <script src="assets/js/vue.prod.js"></script>
    <script src="assets/js/element-plus.js"></script>
    <script src="assets/js/axios.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/components/navbar.js"></script>
    <script src="assets/js/components/media-manager.js"></script>
</body>
</html>