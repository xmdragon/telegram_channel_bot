<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â™í‰ΩìÊñá‰ª∂ÁÆ°ÁêÜ</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="assets/css/element-plus.css">
    <link rel="stylesheet" href="assets/css/element-plus-fixes.css">
    <link rel="stylesheet" href="assets/css/modern-ui.css">
    <link rel="stylesheet" href="assets/css/training-common.css">
    <link rel="stylesheet" href="assets/css/media-manager.css">
    <link rel="stylesheet" href="assets/css/training-nav.css">
</head>
<body>
    <div id="app">
        <!-- ÂØºËà™Ê†è -->
        <nav-bar page-title="ü§ñ AIËÆ≠ÁªÉ‰∏≠ÂøÉ"></nav-bar>

        <div class="container" style="max-width: 1400px !important; margin: 0 auto !important; padding: 20px !important;">
            <!-- Â≠êÂØºËà™ -->
            <training-nav active-tab="media"></training-nav>
            <!-- ÁªüËÆ°‰ø°ÊÅØ -->
            <div class="stats-section compact">
                <div class="stats-inline">
                    <div class="stat-item-inline">
                        <span class="stat-label">Êñá‰ª∂ÊÄªÊï∞:</span>
                        <span class="stat-value">{{ stats.totalFiles }}</span>
                    </div>
                    <div class="stat-item-inline">
                        <span class="stat-label">ÂõæÁâá:</span>
                        <span class="stat-value">{{ stats.imageCount }}</span>
                    </div>
                    <div class="stat-item-inline">
                        <span class="stat-label">ËßÜÈ¢ë:</span>
                        <span class="stat-value">{{ stats.videoCount }}</span>
                    </div>
                    <div class="stat-item-inline">
                        <span class="stat-label">ÊÄªÂ§ßÂ∞è:</span>
                        <span class="stat-value">{{ formatSize(stats.totalSize) }}</span>
                    </div>
                    <div class="stat-item-inline">
                        <span class="stat-label">Â∑≤ÂºïÁî®:</span>
                        <span class="stat-value">{{ stats.referencedCount }}</span>
                    </div>
                    <div class="stat-item-inline">
                        <span class="stat-label">Êú™ÂºïÁî®:</span>
                        <span class="stat-value">{{ stats.orphanedCount }}</span>
                    </div>
                </div>
            </div>

            <!-- Êìç‰ΩúÊåâÈíÆ -->
            <div class="toolbar-section">
                <div class="toolbar-card">
                    <div class="toolbar-content">
                        <div class="btn-group">
                            <el-button @click="loadMediaFiles" type="default">
                                Âà∑Êñ∞ÂàóË°®
                            </el-button>
                            <el-button @click="cleanOrphaned" type="warning">
                                Ê∏ÖÁêÜÊú™ÂºïÁî®
                            </el-button>
                            <el-button @click="checkDuplicates" type="info">
                                Ê£ÄÊµãÈáçÂ§ç
                            </el-button>
                            <el-button @click="deduplicateMedia" type="danger">
                                ÊâßË°åÂéªÈáç
                            </el-button>
                            <el-button @click="rebuildVisualHashes" type="primary">
                                ÈáçÂª∫ÂìàÂ∏å
                            </el-button>
                            <el-button @click="optimizeVideos" type="primary">
                                ‰ºòÂåñËßÜÈ¢ë
                            </el-button>
                            <el-button @click="downloadAll" type="success">
                                ÂØºÂá∫ÊâÄÊúâ
                            </el-button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Â™í‰ΩìÊñá‰ª∂ÂàóË°® -->
            <div class="table-section">
                <div class="table-card">
                    <div class="table-header">
                        <div class="flex-between">
                            <h3 class="table-title">üìÅ Â™í‰ΩìÊñá‰ª∂</h3>
                            <div class="toolbar-right">
                                <el-input v-model="searchKeyword" placeholder="ÊêúÁ¥¢Êñá‰ª∂Âêç" clearable class="search-input">
                                    <template #prefix>
                                        <el-icon><Search /></el-icon>
                                    </template>
                                </el-input>
                                <el-select v-model="filterType" placeholder="Á±ªÂûã" class="filter-select">
                                    <el-option label="ÂÖ®ÈÉ®" value="all"></el-option>
                                    <el-option label="ÂõæÁâá" value="image"></el-option>
                                    <el-option label="ËßÜÈ¢ë" value="video"></el-option>
                                    <el-option label="Â∑≤ÂºïÁî®" value="referenced"></el-option>
                                    <el-option label="Êú™ÂºïÁî®" value="orphaned"></el-option>
                                </el-select>
                            </div>
                        </div>
                    </div>
                <div class="table-content">
                    <div v-if="loading" class="loading-container">
                        <el-icon class="is-loading" size="40">
                            <Loading />
                        </el-icon>
                        <p class="loading-text">Âä†ËΩΩ‰∏≠...</p>
                    </div>
                    
                    <div v-else-if="!filteredFiles.length" class="empty-container">
                        ÊöÇÊó†Â™í‰ΩìÊñá‰ª∂
                    </div>
                    
                    <div v-else class="media-grid">
                        <div v-for="file in paginatedFiles" :key="file.hash" class="media-card">
                            <img
                                v-if="file.type === 'image'"
                                :src="'/media/ad_training_data/' + file.path"
                                class="media-preview-image"
                                @click.stop="previewImage(file, $event)"
                                @error="handleImageError"
                                loading="lazy"
                            />
                            
                            <video v-else :src="'/media/ad_training_data/' + file.path" class="media-preview-video" preload="metadata"></video>
                            
                            <div class="media-info">
                                <div class="media-name" :title="file.name">{{ file.name }}</div>
                                <div class="media-size">{{ formatSize(file.size) }}</div>
                                <div class="reference-info">
                                    ÂºïÁî®: {{ file.messageIds.length }} ‰∏™Ê†∑Êú¨
                                </div>
                            </div>
                            
                            <div class="media-actions">
                                <el-button size="small" type="primary" class="btn-primary" @click="viewDetails(file)">ËØ¶ÊÉÖ</el-button>
                                <el-button size="small" type="danger" class="btn-danger" @click="deleteFile(file)">Âà†Èô§</el-button>
                            </div>
                        </div>
                    </div>
                </div>
                    
                    <!-- ÂàÜÈ°µ -->
                    <div class="pagination-section" v-if="filteredFiles.length > pageSize">
                        <el-pagination
                            v-model:current-page="currentPage"
                            :page-size="pageSize"
                            :total="filteredFiles.length"
                            layout="prev, pager, next, total"
                            class="pagination"
                        />
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Êñá‰ª∂ËØ¶ÊÉÖÂØπËØùÊ°Ü -->
        <el-dialog v-model="detailDialog" title="Êñá‰ª∂ËØ¶ÊÉÖ" width="800px" class="file-details-dialog">
            <div v-if="currentFile">
                <el-descriptions :column="1" border>
                    <el-descriptions-item label="Êñá‰ª∂Âêç">{{ currentFile.name }}</el-descriptions-item>
                    <el-descriptions-item label="Ë∑ØÂæÑ">{{ currentFile.path }}</el-descriptions-item>
                    <el-descriptions-item label="Á±ªÂûã">{{ currentFile.type }}</el-descriptions-item>
                    <el-descriptions-item label="Â§ßÂ∞è">{{ formatSize(currentFile.size) }}</el-descriptions-item>
                    <el-descriptions-item label="ÂìàÂ∏å">{{ currentFile.hash }}</el-descriptions-item>
                    <el-descriptions-item label="ÂàõÂª∫Êó∂Èó¥">{{ currentFile.createdAt }}</el-descriptions-item>
                    <el-descriptions-item label="ÂºïÁî®Ê†∑Êú¨">
                        <el-tag v-for="id in currentFile.messageIds" :key="id" class="dialog-tag">
                            #{{ id }}
                        </el-tag>
                    </el-descriptions-item>
                    <el-descriptions-item label="OCRËØÜÂà´ÁªìÊûú" v-if="currentFile.type === 'image'">
                        <div v-if="currentFile.ocrLoading" class="ocr-loading">
                            <el-icon class="is-loading"><Loading /></el-icon>
                            <span>Ê≠£Âú®ËØÜÂà´ÂõæÁâáÂÜÖÂÆπ...</span>
                        </div>
                        <div v-else-if="currentFile.ocrResult" class="ocr-result">
                            <div v-if="currentFile.ocrResult.texts && currentFile.ocrResult.texts.length > 0" class="ocr-section">
                                <strong>ËØÜÂà´ÊñáÂ≠ó ({{ currentFile.ocrResult.texts.length }}Êù°):</strong>
                                <div class="ocr-text-list">
                                    <el-tag v-for="(text, index) in currentFile.ocrResult.texts" :key="index" 
                                           type="info" class="ocr-text-tag">
                                        {{ text }}
                                    </el-tag>
                                </div>
                            </div>
                            <div v-if="currentFile.ocrResult.qr_codes && currentFile.ocrResult.qr_codes.length > 0" class="ocr-section">
                                <strong>‰∫åÁª¥Á†ÅÂÜÖÂÆπ ({{ currentFile.ocrResult.qr_codes.length }}‰∏™):</strong>
                                <div class="ocr-text-list">
                                    <el-tag v-for="(qr, index) in currentFile.ocrResult.qr_codes" :key="index" 
                                           type="warning" class="ocr-text-tag">
                                        <el-icon><QrCode /></el-icon> {{ qr.data || qr }}
                                    </el-tag>
                                </div>
                            </div>
                            <div v-if="currentFile.ocrResult.ad_score !== undefined" class="ocr-section">
                                <strong>ÂπøÂëäÂàÜÊï∞:</strong>
                                <el-tag :type="getAdScoreType(currentFile.ocrResult.ad_score)" class="ad-score-tag">
                                    {{ currentFile.ocrResult.ad_score.toFixed(1) }}/100
                                </el-tag>
                                <span v-if="currentFile.ocrResult.is_ad" class="ad-indicator">
                                    <el-icon color="red"><Warning /></el-icon> Áñë‰ººÂπøÂëä
                                </span>
                            </div>
                            <div v-if="currentFile.ocrResult.ad_indicators && currentFile.ocrResult.ad_indicators.length > 0" class="ocr-section">
                                <strong>ÂπøÂëäÁâπÂæÅ:</strong>
                                <div class="ocr-text-list">
                                    <el-tag v-for="(indicator, index) in currentFile.ocrResult.ad_indicators" :key="index" 
                                           type="danger" class="ocr-text-tag">
                                        {{ indicator }}
                                    </el-tag>
                                </div>
                            </div>
                            <div v-if="(!currentFile.ocrResult.texts || currentFile.ocrResult.texts.length === 0) && 
                                     (!currentFile.ocrResult.qr_codes || currentFile.ocrResult.qr_codes.length === 0)" class="ocr-empty">
                                <el-icon><InfoFilled /></el-icon>
                                <span>Êú™ËØÜÂà´Âà∞ÊñáÂ≠óÊàñ‰∫åÁª¥Á†ÅÂÜÖÂÆπ</span>
                            </div>
                        </div>
                        <div v-else-if="currentFile.ocrError" class="ocr-error">
                            <el-icon color="red"><CircleCloseFilled /></el-icon>
                            <span>OCRËØÜÂà´Â§±Ë¥•: {{ currentFile.ocrError }}</span>
                        </div>
                    </el-descriptions-item>
                </el-descriptions>
                
                <div class="dialog-footer">
                    <el-image
                        v-if="currentFile.type === 'image'"
                        :src="'/media/ad_training_data/' + currentFile.path"
                        class="dialog-image"
                        fit="contain"
                    />
                </div>
            </div>
        </el-dialog>
        
        <!-- ‰ºòÂåñËøõÂ∫¶ÂØπËØùÊ°Ü -->
        <el-dialog
            v-model="optimizeProgress.visible"
            title="ËßÜÈ¢ë‰ºòÂåñËøõÂ∫¶"
            width="600px"
            :close-on-click-modal="false"
            :close-on-press-escape="false"
            :show-close="!optimizing"
        >
            <div class="optimize-progress-content">
                <div class="progress-info">
                    <el-progress 
                        :percentage="optimizeProgress.percent" 
                        :stroke-width="20"
                        :text-inside="true"
                        status="success"
                    />
                    
                    <div class="progress-details">
                        <p>
                            <strong>Â§ÑÁêÜËøõÂ∫¶Ôºö</strong>
                            {{ optimizeProgress.current }} / {{ optimizeProgress.total }} ‰∏™Êñá‰ª∂
                        </p>
                        <p>
                            <strong>ÂΩìÂâçÊñá‰ª∂Ôºö</strong>
                            <span class="current-file">{{ optimizeProgress.currentFile }}</span>
                        </p>
                        <p v-if="optimizeProgress.savedMb > 0">
                            <strong>Â∑≤ËäÇÁúÅÁ©∫Èó¥Ôºö</strong>
                            <el-tag type="success">{{ optimizeProgress.savedMb.toFixed(2) }} MB</el-tag>
                        </p>
                    </div>
                    
                    <div v-if="optimizeProgress.errors.length > 0" class="error-list">
                        <el-alert
                            title="Â§ÑÁêÜÈîôËØØ"
                            type="warning"
                            :closable="false"
                            show-icon
                        >
                            <ul class="error-list-items">
                                <li v-for="(error, index) in optimizeProgress.errors.slice(0, 5)" :key="index">
                                    {{ error }}
                                </li>
                                <li v-if="optimizeProgress.errors.length > 5">
                                    ËøòÊúâ {{ optimizeProgress.errors.length - 5 }} ‰∏™ÈîôËØØ...
                                </li>
                            </ul>
                        </el-alert>
                    </div>
                </div>
            </div>
            
            <template #footer v-if="!optimizing">
                <el-button @click="optimizeProgress.visible = false">ÂÖ≥Èó≠</el-button>
            </template>
        </el-dialog>
    </div>

    <script src="assets/js/vue.prod.js"></script>
    <script src="assets/js/element-plus.js"></script>
    <script src="assets/js/axios.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/components/navbar.js"></script>
    <script src="assets/js/components/training-nav.js"></script>
    <script src="assets/js/components/media-manager.js"></script>
</body>
</html>