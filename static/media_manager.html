<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åª’ä½“æ–‡ä»¶ç®¡ç†</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="assets/css/element-plus.css">
    <link rel="stylesheet" href="assets/css/element-plus-fixes.css">
    <link rel="stylesheet" href="assets/css/modern-ui.css">
    <link rel="stylesheet" href="assets/css/media-manager.css">
</head>
<body>
    <div id="app">
        <!-- å¯¼èˆªæ  -->
        <nav-bar page-title="ğŸ–¼ï¸ åª’ä½“æ–‡ä»¶ç®¡ç†"></nav-bar>

        <div class="container">
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ“Š åª’ä½“ç»Ÿè®¡</h2>
                </div>
                <div class="card-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">{{ stats.totalFiles }}</div>
                            <div class="stat-label">æ–‡ä»¶æ€»æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">{{ stats.imageCount }}</div>
                            <div class="stat-label">å›¾ç‰‡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">{{ stats.videoCount }}</div>
                            <div class="stat-label">è§†é¢‘</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">{{ formatSize(stats.totalSize) }}</div>
                            <div class="stat-label">æ€»å¤§å°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">{{ stats.referencedCount }}</div>
                            <div class="stat-label">å·²å¼•ç”¨</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">{{ stats.orphanedCount }}</div>
                            <div class="stat-label">æœªå¼•ç”¨</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ”§ æ‰¹é‡æ“ä½œ</h2>
                </div>
                <div class="card-content">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <el-button @click="loadMediaFiles" icon="Refresh">åˆ·æ–°åˆ—è¡¨</el-button>
                        <el-button @click="cleanOrphaned" type="warning" icon="Delete">æ¸…ç†æœªå¼•ç”¨æ–‡ä»¶</el-button>
                        <el-button @click="checkDuplicates" type="info" icon="Search">æ£€æµ‹é‡å¤</el-button>
                        <el-button @click="deduplicateMedia" type="danger" icon="FolderDelete">æ‰§è¡Œå»é‡</el-button>
                        <el-button @click="rebuildVisualHashes" type="primary" icon="Refresh">é‡å»ºè§†è§‰å“ˆå¸Œ</el-button>
                        <el-button @click="optimizeVideos" type="primary" icon="VideoCamera">ä¼˜åŒ–è§†é¢‘ï¼ˆè½¬å¿«ç…§ï¼‰</el-button>
                        <el-button @click="downloadAll" type="success" icon="Download">å¯¼å‡ºæ‰€æœ‰åª’ä½“</el-button>
                    </div>
                </div>
            </div>

            <!-- åª’ä½“æ–‡ä»¶åˆ—è¡¨ -->
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ“ åª’ä½“æ–‡ä»¶</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <el-input v-model="searchKeyword" placeholder="æœç´¢æ–‡ä»¶å" clearable style="width: 200px;">
                            <template #prefix>
                                <el-icon><Search /></el-icon>
                            </template>
                        </el-input>
                        <el-select v-model="filterType" placeholder="ç±»å‹" style="width: 120px;">
                            <el-option label="å…¨éƒ¨" value="all"></el-option>
                            <el-option label="å›¾ç‰‡" value="image"></el-option>
                            <el-option label="è§†é¢‘" value="video"></el-option>
                            <el-option label="å·²å¼•ç”¨" value="referenced"></el-option>
                            <el-option label="æœªå¼•ç”¨" value="orphaned"></el-option>
                        </el-select>
                    </div>
                </div>
                <div class="card-content">
                    <div v-if="loading" style="text-align: center; padding: 50px;">
                        <el-icon class="is-loading" size="40">
                            <Loading />
                        </el-icon>
                        <p style="margin-top: 10px; color: #999;">åŠ è½½ä¸­...</p>
                    </div>
                    
                    <div v-else-if="!filteredFiles.length" style="text-align: center; padding: 50px; color: #999;">
                        æš‚æ— åª’ä½“æ–‡ä»¶
                    </div>
                    
                    <div v-else class="media-grid">
                        <div v-for="file in paginatedFiles" :key="file.hash" class="media-card">
                            <img
                                v-if="file.type === 'image'"
                                :src="'/media/ad_training_data/' + file.path"
                                class="media-preview"
                                @click.stop="previewImage(file, $event)"
                                @error="handleImageError"
                                style="width: 100%; height: 200px; object-fit: cover; cursor: pointer; display: block;"
                                loading="lazy"
                            />
                            
                            <video v-else :src="'/media/ad_training_data/' + file.path" class="media-preview" preload="metadata" style="width: 100%; height: 200px; object-fit: cover;"></video>
                            
                            <div class="media-info">
                                <div class="media-name" :title="file.name">{{ file.name }}</div>
                                <div class="media-size">{{ formatSize(file.size) }}</div>
                                <div style="color: #666; margin-top: 5px;">
                                    å¼•ç”¨: {{ file.messageIds.length }} ä¸ªæ ·æœ¬
                                </div>
                            </div>
                            
                            <div class="media-actions">
                                <el-button size="small" @click="viewDetails(file)">è¯¦æƒ…</el-button>
                                <el-button size="small" type="danger" @click="deleteFile(file)">åˆ é™¤</el-button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åˆ†é¡µ -->
                    <div v-if="filteredFiles.length > pageSize" style="margin-top: 20px; text-align: center;">
                        <el-pagination
                            v-model:current-page="currentPage"
                            :page-size="pageSize"
                            :total="filteredFiles.length"
                            layout="prev, pager, next, total"
                        />
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ–‡ä»¶è¯¦æƒ…å¯¹è¯æ¡† -->
        <el-dialog v-model="detailDialog" title="æ–‡ä»¶è¯¦æƒ…" width="800px" class="file-details-dialog">
            <div v-if="currentFile">
                <el-descriptions :column="1" border>
                    <el-descriptions-item label="æ–‡ä»¶å">{{ currentFile.name }}</el-descriptions-item>
                    <el-descriptions-item label="è·¯å¾„">{{ currentFile.path }}</el-descriptions-item>
                    <el-descriptions-item label="ç±»å‹">{{ currentFile.type }}</el-descriptions-item>
                    <el-descriptions-item label="å¤§å°">{{ formatSize(currentFile.size) }}</el-descriptions-item>
                    <el-descriptions-item label="å“ˆå¸Œ">{{ currentFile.hash }}</el-descriptions-item>
                    <el-descriptions-item label="åˆ›å»ºæ—¶é—´">{{ currentFile.createdAt }}</el-descriptions-item>
                    <el-descriptions-item label="å¼•ç”¨æ ·æœ¬">
                        <el-tag v-for="id in currentFile.messageIds" :key="id" style="margin-right: 5px;">
                            #{{ id }}
                        </el-tag>
                    </el-descriptions-item>
                </el-descriptions>
                
                <div class="dialog-footer">
                    <el-image
                        v-if="currentFile.type === 'image'"
                        :src="'/media/ad_training_data/' + currentFile.path"
                        class="dialog-image"
                        fit="contain"
                    />
                </div>
            </div>
        </el-dialog>
        
        <!-- ä¼˜åŒ–è¿›åº¦å¯¹è¯æ¡† -->
        <el-dialog
            v-model="optimizeProgress.visible"
            title="è§†é¢‘ä¼˜åŒ–è¿›åº¦"
            width="600px"
            :close-on-click-modal="false"
            :close-on-press-escape="false"
            :show-close="!optimizing"
        >
            <div class="optimize-progress-content">
                <div class="progress-info">
                    <el-progress 
                        :percentage="optimizeProgress.percent" 
                        :stroke-width="20"
                        :text-inside="true"
                        status="success"
                    />
                    
                    <div class="progress-details">
                        <p>
                            <strong>å¤„ç†è¿›åº¦ï¼š</strong>
                            {{ optimizeProgress.current }} / {{ optimizeProgress.total }} ä¸ªæ–‡ä»¶
                        </p>
                        <p>
                            <strong>å½“å‰æ–‡ä»¶ï¼š</strong>
                            <span class="current-file">{{ optimizeProgress.currentFile }}</span>
                        </p>
                        <p v-if="optimizeProgress.savedMb > 0">
                            <strong>å·²èŠ‚çœç©ºé—´ï¼š</strong>
                            <el-tag type="success">{{ optimizeProgress.savedMb.toFixed(2) }} MB</el-tag>
                        </p>
                    </div>
                    
                    <div v-if="optimizeProgress.errors.length > 0" class="error-list">
                        <el-alert
                            title="å¤„ç†é”™è¯¯"
                            type="warning"
                            :closable="false"
                            show-icon
                        >
                            <ul style="margin: 5px 0; padding-left: 20px;">
                                <li v-for="(error, index) in optimizeProgress.errors.slice(0, 5)" :key="index">
                                    {{ error }}
                                </li>
                                <li v-if="optimizeProgress.errors.length > 5">
                                    è¿˜æœ‰ {{ optimizeProgress.errors.length - 5 }} ä¸ªé”™è¯¯...
                                </li>
                            </ul>
                        </el-alert>
                    </div>
                </div>
            </div>
            
            <template #footer v-if="!optimizing">
                <el-button @click="optimizeProgress.visible = false">å…³é—­</el-button>
            </template>
        </el-dialog>
    </div>

    <script src="assets/js/vue.prod.js"></script>
    <script src="assets/js/element-plus.js"></script>
    <script src="assets/js/axios.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/components/navbar.js"></script>
    <script src="assets/js/components/media-manager.js"></script>
</body>
</html>