<!DOCTYPE html>
<html>
<head>
    <title>API时间测试</title>
    <meta charset="utf-8">
    <script src="/static/assets/js/axios.js"></script>
    <script src="/static/assets/js/auth.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; }
        .message { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        .raw { background: #f0f0f0; padding: 10px; white-space: pre-wrap; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>API时间测试</h1>
    <button onclick="testAPI()">测试API</button>
    <button onclick="clearResults()">清除结果</button>
    
    <div id="results"></div>
    
    <script>
        async function testAPI() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>正在请求API...</p>';
            
            try {
                // 调用实际的API
                const response = await axios.get('/api/messages/', {
                    params: { page: 1, size: 3 }
                });
                
                console.log('API响应:', response.data);
                
                let html = '<h2>API响应</h2>';
                html += '<div class="raw">原始响应:\n' + JSON.stringify(response.data, null, 2) + '</div>';
                
                if (response.data.messages && response.data.messages.length > 0) {
                    html += '<h2>消息时间分析</h2>';
                    
                    response.data.messages.forEach((msg, index) => {
                        const createdAt = msg.created_at;
                        html += `<div class="message">`;
                        html += `<h3>消息 ${index + 1} (ID: ${msg.id})</h3>`;
                        html += `<p>created_at原始值: <code>${createdAt}</code></p>`;
                        html += `<p>类型: ${typeof createdAt}</p>`;
                        
                        if (createdAt) {
                            // 解析时间
                            const date = new Date(createdAt);
                            const now = new Date();
                            const diff = now - date;
                            
                            html += `<p>解析后Date: ${date.toString()}</p>`;
                            html += `<p>ISO格式: ${date.toISOString()}</p>`;
                            html += `<p>本地时间: ${date.toLocaleString()}</p>`;
                            html += `<p>当前时间: ${now.toString()}</p>`;
                            html += `<p>时间差(毫秒): ${diff}</p>`;
                            html += `<p>时间差(分钟): ${Math.floor(diff / 60000)}</p>`;
                            html += `<p>时间差(小时): ${(diff / 3600000).toFixed(1)}</p>`;
                            
                            // 使用formatTime函数
                            const formatted = formatTime(createdAt);
                            html += `<p class="success">formatTime结果: <strong>${formatted}</strong></p>`;
                        }
                        
                        html += `</div>`;
                    });
                } else {
                    html += '<p class="error">没有消息数据</p>';
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('API错误:', error);
                resultsDiv.innerHTML = `<div class="error">错误: ${error.message}</div>`;
                if (error.response) {
                    resultsDiv.innerHTML += `<div class="raw">响应内容:\n${JSON.stringify(error.response.data, null, 2)}</div>`;
                }
            }
        }
        
        function formatTime(dateString) {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diff = now - date;
                
                console.log('formatTime调试:');
                console.log('  输入:', dateString);
                console.log('  解析后:', date);
                console.log('  当前时间:', now);
                console.log('  差值(ms):', diff);
                console.log('  差值(小时):', diff / 3600000);
                
                if (diff < 60000) return '刚刚';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}分钟前`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}小时前`;
                if (diff < 604800000) return `${Math.floor(diff / 86400000)}天前`;
                
                return date.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return dateString;
            }
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        // 页面加载后自动测试
        window.onload = function() {
            console.log('页面加载完成，准备测试');
            // 检查认证状态
            if (typeof authManager !== 'undefined') {
                console.log('Auth状态:', authManager.isAuthenticated());
            }
        };
    </script>
</body>
</html>