<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš™ï¸ ç³»ç»Ÿé…ç½®ä¸­å¿ƒ</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    
    <!-- å¤–éƒ¨æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="assets/css/element-plus.css">
    <link rel="stylesheet" href="assets/css/element-plus-fixes.css">
    <link rel="stylesheet" href="assets/css/modern-ui.css">
    
    <!-- å¤–éƒ¨è„šæœ¬æ–‡ä»¶ -->
    <script src="assets/js/vue.prod.js"></script>
    <script src="assets/js/element-plus.js"></script>
    <script src="assets/js/axios.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/components/navbar.js"></script>
    <script src="assets/js/message-manager.js?v=1"></script>
    <script src="assets/js/components/config.js"></script>
</head>
<body>
    <div id="app">
        <!-- å¯¼èˆªæ  -->
        <nav-bar page-title="âš™ï¸ ç³»ç»Ÿé…ç½®ä¸­å¿ƒ" page-subtitle="é¢‘é“ç®¡ç† Â· è¿‡æ»¤è§„åˆ™ Â· è½¬å‘è®¾ç½®"></nav-bar>

        <div class="container">
            <!-- é…ç½®æ ‡ç­¾é¡µ -->
            <el-tabs v-model="activeTab" type="border-card" class="config-tabs">
                <!-- é¢‘é“ç®¡ç† -->
                <el-tab-pane label="ğŸ“¡ é¢‘é“ç®¡ç†" name="channels">
                    <div class="config-section">
                        <div class="add-channel-form">
                            <el-tabs v-model="addChannelTab" type="card">
                                <!-- å•ä¸ªæ·»åŠ  -->
                                <el-tab-pane label="å•ä¸ªæ·»åŠ " name="single">
                                    <el-form :model="newChannel" label-width="100px">
                                        <el-form-item label="é¢‘é“åç§°">
                                            <el-input 
                                                v-model="newChannel.name" 
                                                placeholder="è¾“å…¥é¢‘é“åç§°ï¼ˆå¦‚ï¼š@channelname æˆ– channelnameï¼‰"
                                                @keyup.enter="addChannel">
                                                <template #append>
                                                    <el-button @click="addChannel" icon="Plus" :loading="loading">
                                                        æ·»åŠ 
                                                    </el-button>
                                                </template>
                                            </el-input>
                                        </el-form-item>
                                        <el-form-item>
                                            <div style="color: #909399; font-size: 12px;">
                                                <i class="el-icon-info"></i> 
                                                é¢‘é“IDå’Œæ ‡é¢˜ä¼šè‡ªåŠ¨è§£æï¼Œæ— éœ€æ‰‹åŠ¨å¡«å†™
                                            </div>
                                        </el-form-item>
                                    </el-form>
                                </el-tab-pane>
                                
                                <!-- æ‰¹é‡æ·»åŠ  -->
                                <el-tab-pane label="æ‰¹é‡æ·»åŠ " name="batch">
                                    <el-form :model="batchChannel" label-width="100px">
                                        <el-form-item label="é¢‘é“åˆ—è¡¨">
                                            <el-input
                                                v-model="batchChannel.channels"
                                                type="textarea"
                                                :rows="6"
                                                placeholder="æ¯è¡Œè¾“å…¥ä¸€ä¸ªé¢‘é“åç§°ï¼Œæ”¯æŒä»¥ä¸‹æ ¼å¼ï¼š&#10;@channelname&#10;https://t.me/channelname&#10;channelname">
                                            </el-input>
                                        </el-form-item>
                                        <el-form-item>
                                            <el-button type="primary" @click="batchAddChannels" :loading="batchChannel.loading" icon="Upload">
                                                æ‰¹é‡æ·»åŠ 
                                            </el-button>
                                            <el-button @click="batchChannel.channels = ''" icon="Delete">æ¸…ç©º</el-button>
                                        </el-form-item>
                                    </el-form>
                                    
                                    <!-- æ‰¹é‡æ·»åŠ ç»“æœ -->
                                    <div v-if="batchChannel.results" style="margin-top: 20px;">
                                        <el-alert 
                                            :title="batchChannel.message" 
                                            :type="batchChannel.success ? 'success' : 'warning'"
                                            :closable="false"
                                            show-icon>
                                        </el-alert>
                                        
                                        <!-- æ·»åŠ æˆåŠŸçš„é¢‘é“ -->
                                        <div v-if="batchChannel.results.added && batchChannel.results.added.length > 0" style="margin-top: 10px;">
                                            <h5>âœ… æˆåŠŸæ·»åŠ çš„é¢‘é“ï¼š</h5>
                                            <el-tag v-for="channel in batchChannel.results.added" :key="channel.channel_name" style="margin: 2px;">
                                                {{ channel.channel_title }} ({{ channel.channel_name }})
                                            </el-tag>
                                        </div>
                                        
                                        <!-- å·²å­˜åœ¨çš„é¢‘é“ -->
                                        <div v-if="batchChannel.results.existed && batchChannel.results.existed.length > 0" style="margin-top: 10px;">
                                            <h5>â„¹ï¸ å·²å­˜åœ¨çš„é¢‘é“ï¼š</h5>
                                            <el-tag v-for="channel in batchChannel.results.existed" :key="channel" type="info" style="margin: 2px;">
                                                {{ channel }}
                                            </el-tag>
                                        </div>
                                        
                                        <!-- è‡ªåŠ¨è®¢é˜…çš„é¢‘é“ -->
                                        <div v-if="batchChannel.results.subscribed && batchChannel.results.subscribed.length > 0" style="margin-top: 10px;">
                                            <h5>ğŸ”” è‡ªåŠ¨è®¢é˜…çš„é¢‘é“ï¼š</h5>
                                            <el-tag v-for="channel in batchChannel.results.subscribed" :key="channel" type="success" style="margin: 2px;">
                                                {{ channel }}
                                            </el-tag>
                                        </div>
                                        
                                        <!-- æ·»åŠ å¤±è´¥çš„é¢‘é“ -->
                                        <div v-if="batchChannel.results.failed && batchChannel.results.failed.length > 0" style="margin-top: 10px;">
                                            <h5>âŒ æ·»åŠ å¤±è´¥çš„é¢‘é“ï¼š</h5>
                                            <div v-for="item in batchChannel.results.failed" :key="item.channel_name" style="margin: 5px 0;">
                                                <el-tag type="danger">{{ item.channel_name }}</el-tag>
                                                <span style="color: #F56C6C; margin-left: 10px;">{{ item.reason }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </el-tab-pane>
                            </el-tabs>
                        </div>

                        <!-- æœç´¢Telegramé¢‘é“ï¼ˆæš‚æ—¶éšè—ï¼‰ -->
                        <div class="search-channel-form" style="margin-top: 20px; padding: 15px; border: 1px solid #e4e7ed; border-radius: 4px; display: none;">
                            <h4>æœç´¢Telegramé¢‘é“</h4>
                            <el-form :model="searchForm" label-width="100px">
                                <el-form-item label="æœç´¢å…³é”®è¯">
                                    <el-input 
                                        v-model="searchForm.query" 
                                        placeholder="è¾“å…¥é¢‘é“åç§°æˆ–å…³é”®è¯æœç´¢"
                                        clearable>
                                        <template #append>
                                            <el-button @click="searchChannels" :loading="searchForm.loading">
                                                <el-icon><Search /></el-icon> æœç´¢
                                            </el-button>
                                        </template>
                                    </el-input>
                                </el-form-item>
                            </el-form>
                            
                            <!-- æœç´¢ç»“æœ -->
                            <div v-if="searchForm.results.length > 0" class="search-results" style="margin-top: 15px;">
                                <h5>æœç´¢ç»“æœï¼š</h5>
                                <div v-for="result in searchForm.results" :key="result.id" class="search-result-item" style="padding: 10px; margin: 5px 0; border: 1px solid #e4e7ed; border-radius: 4px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>{{ result.title }}</strong>
                                            <span style="color: #909399; margin-left: 10px;">ID: {{ result.id }}</span>
                                            <el-tag size="small" style="margin-left: 10px;">{{ result.participants_count || 'N/A' }} æˆå‘˜</el-tag>
                                        </div>
                                        <el-button 
                                            size="small" 
                                            type="primary"
                                            @click="addSearchedChannel(result)">
                                            æ·»åŠ ç›‘å¬
                                        </el-button>
                                    </div>
                                    <div v-if="result.description" style="color: #606266; margin-top: 5px; font-size: 13px;">
                                        {{ result.description }}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æ— ç»“æœæç¤º -->
                            <div v-else-if="searchForm.searched && searchForm.results.length === 0" style="margin-top: 15px; text-align: center; color: #909399;">
                                æ²¡æœ‰æ‰¾åˆ°ç›¸å…³é¢‘é“
                            </div>
                        </div>

                        <h3>ç›‘å¬é¢‘é“åˆ—è¡¨</h3>
                        
                        <!-- é¢‘é“æœç´¢è¿‡æ»¤ -->
                        <div style="margin-bottom: 20px;">
                            <el-input 
                                v-model="channelSearchFilter" 
                                placeholder="æœç´¢é¢‘é“åç§°æˆ–æ ‡é¢˜..."
                                clearable
                                prefix-icon="Search"
                                style="width: 300px;">
                            </el-input>
                            <span style="margin-left: 10px; color: #909399;">
                                å…± {{ filteredChannels.length }} / {{ channels.length }} ä¸ªé¢‘é“
                            </span>
                        </div>
                        
                        <div class="channel-list">
                            <div v-for="channel in filteredChannels" :key="channel.id" class="channel-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #e4e7ed;">
                                <div class="channel-info" style="flex: 1; min-width: 0; display: flex; align-items: center; flex-wrap: wrap;">
                                    <span class="channel-title" style="font-weight: 500;">
                                        {{ channel.title || 'æœªè®¾ç½®æ ‡é¢˜' }}
                                    </span>
                                    <span class="channel-name" style="color: #606266; margin-left: 8px;">
                                        ({{ channel.name && channel.name.startsWith('@') ? channel.name : '@' + (channel.name || '') }})
                                    </span>
                                    <span v-if="!channel.channel_id" class="channel-id no-id" style="margin-left: 8px; color: #F56C6C; font-size: 12px;">[æ— ID]</span>
                                    <span v-else class="channel-id has-id" style="color: #909399; margin-left: 8px; font-size: 12px;">[{{ channel.channel_id }}]</span>
                                </div>
                                <div class="channel-actions" style="display: flex; gap: 8px; flex-shrink: 0; align-items: center;">
                                    <el-tag 
                                        :type="channel.status === 'active' ? 'success' : 'danger'" 
                                        size="small"
                                        style="cursor: pointer;"
                                        @click="toggleChannelStatus(channel)">
                                        {{ channel.status === 'active' ? 'æ´»è·ƒ' : 'åœç”¨' }}
                                    </el-tag>
                                    <el-button 
                                        v-if="!channel.channel_id" 
                                        size="small" 
                                        type="primary" 
                                        @click="resolveChannelId(channel.name)">
                                        è§£æID
                                    </el-button>
                                    <el-button size="small" type="danger" @click="removeChannel(channel.name)">
                                        åˆ é™¤
                                    </el-button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="channel-actions-toolbar">
                            <el-button type="primary" @click="resolveAllChannels" icon="Refresh">
                                æ‰¹é‡è§£ææ‰€æœ‰é¢‘é“ID
                            </el-button>
                            <el-text type="info" style="margin-left: 10px;">
                                <small>åŒ…æ‹¬æºé¢‘é“ã€ç›®æ ‡é¢‘é“ã€å®¡æ ¸ç¾¤</small>
                            </el-text>
                        </div>
                    </div>
                </el-tab-pane>

                <!-- è½¬å‘è®¾ç½® -->
                <el-tab-pane label="ğŸ“¤ è½¬å‘è®¾ç½®" name="forwarding">
                    <div class="config-section">
                        <h3>è‡ªåŠ¨è½¬å‘é…ç½®</h3>
                        <el-form :model="forwardingConfig" label-width="150px">
                            <el-form-item label="å¯ç”¨è‡ªåŠ¨è½¬å‘">
                                <el-switch v-model="forwardingConfig.enabled"></el-switch>
                            </el-form-item>
                            <el-form-item label="ç›®æ ‡é¢‘é“">
                                <el-input v-model="forwardingConfig.target_channel" placeholder="è¾“å…¥ç›®æ ‡é¢‘é“åç§°ï¼ˆæ”¯æŒå¸¦@æˆ–ä¸å¸¦@ï¼‰" @blur="updateTargetChannelId"></el-input>
                            </el-form-item>
                            <el-form-item label="ç›®æ ‡é¢‘é“ID">
                                <el-input :value="forwardingConfig.resolved_target_channel_id || 'æœªè§£æ'" readonly>
                                    <template #prepend>
                                        <el-icon><InfoFilled /></el-icon>
                                    </template>
                                    <template #append>
                                        <el-button @click="manualResolveTargetChannel" :loading="loading" size="small">
                                            æ‰‹åŠ¨è§£æ
                                        </el-button>
                                    </template>
                                </el-input>
                                <div class="form-hint">
                                    <small>æ­¤IDç”±ç³»ç»Ÿè‡ªåŠ¨è§£æç”Ÿæˆï¼Œç‚¹å‡»"æ‰‹åŠ¨è§£æ"å¯é‡æ–°è§£æ</small>
                                </div>
                            </el-form-item>
                            <el-form-item label="å®¡æ ¸ç¾¤">
                                <el-input v-model="forwardingConfig.review_group" placeholder="è¾“å…¥å®¡æ ¸ç¾¤é“¾æ¥ã€IDæˆ–ç”¨æˆ·å" @blur="updateReviewGroupId">
                                    <template #prepend>
                                        <el-button @click="showReviewGroupHelp">ğŸ’¡</el-button>
                                    </template>
                                </el-input>
                                <div class="form-hint">
                                    <small>æ”¯æŒç¾¤é“¾æ¥ï¼ˆå¦‚ï¼šhttps://t.me/+xxxï¼‰ã€ç¾¤IDï¼ˆå¦‚ï¼š-1001234567890ï¼‰æˆ–ç¾¤ç”¨æˆ·åï¼ˆå¦‚ï¼š@review_groupï¼‰ã€‚</small>
                                </div>
                            </el-form-item>
                            <el-form-item label="å®¡æ ¸ç¾¤ID">
                                <el-input :value="forwardingConfig.resolved_group_id || 'æœªè§£æ'" readonly>
                                    <template #prepend>
                                        <el-icon><InfoFilled /></el-icon>
                                    </template>
                                    <template #append>
                                        <el-button @click="manualResolveReviewGroup" :loading="loading" size="small">
                                            æ‰‹åŠ¨è§£æ
                                        </el-button>
                                    </template>
                                </el-input>
                                <div class="form-hint">
                                    <small>æ­¤IDç”±ç³»ç»Ÿè‡ªåŠ¨è§£æç”Ÿæˆï¼Œç‚¹å‡»"æ‰‹åŠ¨è§£æ"å¯é‡æ–°è§£æ</small>
                                </div>
                            </el-form-item>
                            <el-form-item label="è½¬å‘å»¶è¿Ÿï¼ˆç§’ï¼‰">
                                <el-input-number v-model="forwardingConfig.delay" :min="0" :max="3600"></el-input-number>
                                <div class="form-hint">
                                    <small>æ¶ˆæ¯åœ¨å®¡æ ¸ç¾¤ä¸­åœç•™å¤šé•¿æ—¶é—´åè‡ªåŠ¨è½¬å‘ï¼ˆ0è¡¨ç¤ºä¸è‡ªåŠ¨è½¬å‘ï¼‰</small>
                                </div>
                            </el-form-item>
                            <el-form-item label="è½¬å‘æ¡ä»¶">
                                <el-checkbox-group v-model="forwardingConfig.conditions">
                                    <el-checkbox label="approved">å·²æ‰¹å‡†æ¶ˆæ¯</el-checkbox>
                                    <el-checkbox label="auto_approved">è‡ªåŠ¨æ‰¹å‡†æ¶ˆæ¯</el-checkbox>
                                </el-checkbox-group>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="primary" @click="saveForwardingConfig">ä¿å­˜é…ç½®</el-button>
                            </el-form-item>
                        </el-form>
                    </div>
                </el-tab-pane>

                <!-- ç³»ç»Ÿè®¾ç½® -->
                <el-tab-pane label="ğŸ”§ ç³»ç»Ÿè®¾ç½®" name="system">
                    <div class="config-section">
                        <h3>ç³»ç»Ÿå‚æ•°é…ç½®</h3>
                        <el-form :model="systemConfig" label-width="150px">
                            <el-form-item label="å®¡æ ¸æ¨¡å¼">
                                <el-radio-group v-model="systemConfig.review_mode">
                                    <el-radio label="manual">æ‰‹åŠ¨å®¡æ ¸</el-radio>
                                    <el-radio label="auto">è‡ªåŠ¨å®¡æ ¸</el-radio>
                                    <el-radio label="hybrid">æ··åˆæ¨¡å¼</el-radio>
                                </el-radio-group>
                            </el-form-item>
                            <el-form-item label="æ¶ˆæ¯ä¿ç•™å¤©æ•°">
                                <el-input-number v-model="systemConfig.retention_days" :min="1" :max="365"></el-input-number>
                            </el-form-item>
                            <el-form-item label="æœ€å¤§å¹¶å‘æ•°">
                                <el-input-number v-model="systemConfig.max_concurrent" :min="1" :max="100"></el-input-number>
                            </el-form-item>
                            <el-form-item label="æ—¥å¿—çº§åˆ«">
                                <el-select v-model="systemConfig.log_level">
                                    <el-option label="DEBUG" value="debug"></el-option>
                                    <el-option label="INFO" value="info"></el-option>
                                    <el-option label="WARNING" value="warning"></el-option>
                                    <el-option label="ERROR" value="error"></el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item label="å†å²æ¶ˆæ¯é‡‡é›†æ•°">
                                <el-input-number v-model="systemConfig.history_message_limit" :min="1" :max="1000" placeholder="50"></el-input-number>
                                <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                    é¦–æ¬¡é‡‡é›†æˆ–é‡å¯åä»é¢‘é“è·å–çš„å†å²æ¶ˆæ¯æ¡æ•°
                                </div>
                            </el-form-item>
                            <el-form-item label="é¢‘é“è½æ¬¾">
                                <el-input 
                                    type="textarea" 
                                    v-model="systemConfig.channel_signature" 
                                    placeholder="è¾“å…¥é¢‘é“è½æ¬¾å†…å®¹ï¼Œæ”¯æŒå¤šè¡Œï¼ˆç”¨å›è½¦æ¢è¡Œï¼‰"
                                    :rows="4">
                                </el-input>
                                <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                    æ¶ˆæ¯ç»è¿‡æ™ºèƒ½å»é™¤å°¾éƒ¨å†…å®¹åï¼Œä¼šè‡ªåŠ¨æ·»åŠ æ­¤è½æ¬¾åˆ°æ¶ˆæ¯å°¾éƒ¨
                                </div>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="primary" @click="saveSystemConfig">ä¿å­˜é…ç½®</el-button>
                                <el-button @click="resetSystemConfig">é‡ç½®é»˜è®¤</el-button>
                            </el-form-item>
                        </el-form>
                    </div>
                </el-tab-pane>
            </el-tabs>
        </div>
        
        <!-- çŠ¶æ€æ¶ˆæ¯ -->
        <div v-if="statusMessage" class="status-message" :class="statusType">
            {{ statusMessage }}
        </div>
        
        <!-- åŠ è½½é®ç½© -->
        <div v-if="loading" class="loading-overlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p>{{ loadingMessage }}</p>
            </div>
        </div>
    </div>
</body>
</html> 