<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚙️ 系统配置中心</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    
    <!-- 外部样式文件 -->
    <link rel="stylesheet" href="assets/css/element-plus.css">
    <link rel="stylesheet" href="assets/css/element-plus-fixes.css">
    <link rel="stylesheet" href="assets/css/modern-ui.css">
    
    <!-- 外部脚本文件 -->
    <script src="assets/js/vue.prod.js"></script>
    <script src="assets/js/element-plus.js"></script>
    <script src="assets/js/axios.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/components/navbar.js"></script>
    <script src="assets/js/message-manager.js?v=1"></script>
    <script src="assets/js/components/config.js"></script>
</head>
<body>
    <div id="app">
        <!-- 导航栏 -->
        <nav-bar page-title="⚙️ 系统配置中心"></nav-bar>

        <div class="container">
            <!-- 配置标签页 -->
            <el-tabs v-model="activeTab" type="border-card" class="config-tabs">
                <!-- 频道管理 -->
                <el-tab-pane label="📡 频道管理" name="channels">
                    <div class="config-section">
                        <div class="add-channel-form">
                            <el-tabs v-model="addChannelTab" type="card">
                                <!-- 单个添加 -->
                                <el-tab-pane label="单个添加" name="single">
                                    <el-form :model="newChannel" label-width="100px">
                                        <el-form-item label="频道名称">
                                            <el-input 
                                                v-model="newChannel.name" 
                                                placeholder="输入频道名称（如：@channelname 或 channelname）"
                                                @keyup.enter="addChannel">
                                                <template #append>
                                                    <el-button @click="addChannel" icon="Plus" :loading="loading">
                                                        添加
                                                    </el-button>
                                                </template>
                                            </el-input>
                                        </el-form-item>
                                        <el-form-item>
                                            <div style="color: #909399; font-size: 12px;">
                                                <i class="el-icon-info"></i> 
                                                频道ID和标题会自动解析，无需手动填写
                                            </div>
                                        </el-form-item>
                                    </el-form>
                                </el-tab-pane>
                                
                                <!-- 批量添加 -->
                                <el-tab-pane label="批量添加" name="batch">
                                    <el-form :model="batchChannel" label-width="100px">
                                        <el-form-item label="频道列表">
                                            <el-input
                                                v-model="batchChannel.channels"
                                                type="textarea"
                                                :rows="6"
                                                placeholder="每行输入一个频道名称，支持以下格式：&#10;@channelname&#10;https://t.me/channelname&#10;channelname">
                                            </el-input>
                                        </el-form-item>
                                        <el-form-item>
                                            <el-button type="primary" @click="batchAddChannels" :loading="batchChannel.loading" icon="Upload">
                                                批量添加
                                            </el-button>
                                            <el-button @click="batchChannel.channels = ''" icon="Delete">清空</el-button>
                                        </el-form-item>
                                    </el-form>
                                    
                                    <!-- 批量添加结果 -->
                                    <div v-if="batchChannel.results" style="margin-top: 20px;">
                                        <el-alert 
                                            :title="batchChannel.message" 
                                            :type="batchChannel.success ? 'success' : 'warning'"
                                            :closable="false"
                                            show-icon>
                                        </el-alert>
                                        
                                        <!-- 添加成功的频道 -->
                                        <div v-if="batchChannel.results.added && batchChannel.results.added.length > 0" style="margin-top: 10px;">
                                            <h5>✅ 成功添加的频道：</h5>
                                            <el-tag v-for="channel in batchChannel.results.added" :key="channel.channel_name" style="margin: 2px;">
                                                {{ channel.channel_title }} ({{ channel.channel_name }})
                                            </el-tag>
                                        </div>
                                        
                                        <!-- 已存在的频道 -->
                                        <div v-if="batchChannel.results.existed && batchChannel.results.existed.length > 0" style="margin-top: 10px;">
                                            <h5>ℹ️ 已存在的频道：</h5>
                                            <el-tag v-for="channel in batchChannel.results.existed" :key="channel" type="info" style="margin: 2px;">
                                                {{ channel }}
                                            </el-tag>
                                        </div>
                                        
                                        <!-- 自动订阅的频道 -->
                                        <div v-if="batchChannel.results.subscribed && batchChannel.results.subscribed.length > 0" style="margin-top: 10px;">
                                            <h5>🔔 自动订阅的频道：</h5>
                                            <el-tag v-for="channel in batchChannel.results.subscribed" :key="channel" type="success" style="margin: 2px;">
                                                {{ channel }}
                                            </el-tag>
                                        </div>
                                        
                                        <!-- 添加失败的频道 -->
                                        <div v-if="batchChannel.results.failed && batchChannel.results.failed.length > 0" style="margin-top: 10px;">
                                            <h5>❌ 添加失败的频道：</h5>
                                            <div v-for="item in batchChannel.results.failed" :key="item.channel_name" style="margin: 5px 0;">
                                                <el-tag type="danger">{{ item.channel_name }}</el-tag>
                                                <span style="color: #F56C6C; margin-left: 10px;">{{ item.reason }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </el-tab-pane>
                            </el-tabs>
                        </div>

                        <!-- 搜索Telegram频道（暂时隐藏） -->
                        <div class="search-channel-form" style="margin-top: 20px; padding: 15px; border: 1px solid #e4e7ed; border-radius: 4px; display: none;">
                            <h4>搜索Telegram频道</h4>
                            <el-form :model="searchForm" label-width="100px">
                                <el-form-item label="搜索关键词">
                                    <el-input 
                                        v-model="searchForm.query" 
                                        placeholder="输入频道名称或关键词搜索"
                                        clearable>
                                        <template #append>
                                            <el-button @click="searchChannels" :loading="searchForm.loading">
                                                <el-icon><Search /></el-icon> 搜索
                                            </el-button>
                                        </template>
                                    </el-input>
                                </el-form-item>
                            </el-form>
                            
                            <!-- 搜索结果 -->
                            <div v-if="searchForm.results.length > 0" class="search-results" style="margin-top: 15px;">
                                <h5>搜索结果：</h5>
                                <div v-for="result in searchForm.results" :key="result.id" class="search-result-item" style="padding: 10px; margin: 5px 0; border: 1px solid #e4e7ed; border-radius: 4px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>{{ result.title }}</strong>
                                            <span style="color: #909399; margin-left: 10px;">ID: {{ result.id }}</span>
                                            <el-tag size="small" style="margin-left: 10px;">{{ result.participants_count || 'N/A' }} 成员</el-tag>
                                        </div>
                                        <el-button 
                                            size="small" 
                                            type="primary"
                                            @click="addSearchedChannel(result)">
                                            添加监听
                                        </el-button>
                                    </div>
                                    <div v-if="result.description" style="color: #606266; margin-top: 5px; font-size: 13px;">
                                        {{ result.description }}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 无结果提示 -->
                            <div v-else-if="searchForm.searched && searchForm.results.length === 0" style="margin-top: 15px; text-align: center; color: #909399;">
                                没有找到相关频道
                            </div>
                        </div>

                        <h3>监听频道列表</h3>
                        
                        <!-- 频道搜索过滤 -->
                        <div style="margin-bottom: 20px;">
                            <el-input 
                                v-model="channelSearchFilter" 
                                placeholder="搜索频道名称或标题..."
                                clearable
                                prefix-icon="Search"
                                style="width: 300px;">
                            </el-input>
                            <span style="margin-left: 10px; color: #909399;">
                                共 {{ filteredChannels.length }} / {{ channels.length }} 个频道
                            </span>
                        </div>
                        
                        <div class="channel-list">
                            <div v-for="channel in filteredChannels" :key="channel.id" class="channel-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #e4e7ed;">
                                <div class="channel-info" style="flex: 1; min-width: 0; display: flex; align-items: center; flex-wrap: wrap;">
                                    <span class="channel-title" style="font-weight: 500;">
                                        {{ channel.title || '未设置标题' }}
                                    </span>
                                    <span class="channel-name" style="color: #606266; margin-left: 8px;">
                                        ({{ channel.name && channel.name.startsWith('@') ? channel.name : '@' + (channel.name || '') }})
                                    </span>
                                    <span v-if="!channel.channel_id" class="channel-id no-id" style="margin-left: 8px; color: #F56C6C; font-size: 12px;">[无ID]</span>
                                    <span v-else class="channel-id has-id" style="color: #909399; margin-left: 8px; font-size: 12px;">[{{ channel.channel_id }}]</span>
                                </div>
                                <div class="channel-actions" style="display: flex; gap: 8px; flex-shrink: 0; align-items: center;">
                                    <el-tag 
                                        :type="channel.status === 'active' ? 'success' : 'danger'" 
                                        size="small"
                                        style="cursor: pointer;"
                                        @click="toggleChannelStatus(channel)">
                                        {{ channel.status === 'active' ? '活跃' : '停用' }}
                                    </el-tag>
                                    <el-button 
                                        v-if="!channel.channel_id" 
                                        size="small" 
                                        type="primary" 
                                        @click="resolveChannelId(channel.name)">
                                        解析ID
                                    </el-button>
                                    <el-button size="small" type="danger" @click="removeChannel(channel.name)">
                                        删除
                                    </el-button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="channel-actions-toolbar">
                            <el-button type="primary" @click="resolveAllChannels" icon="Refresh">
                                批量解析所有频道ID
                            </el-button>
                            <el-text type="info" style="margin-left: 10px;">
                                <small>包括源频道、目标频道、审核群</small>
                            </el-text>
                        </div>
                    </div>
                </el-tab-pane>

                <!-- 转发设置 -->
                <el-tab-pane label="📤 转发设置" name="forwarding">
                    <div class="config-section">
                        <h3>自动转发配置</h3>
                        <el-form :model="forwardingConfig" label-width="150px">
                            <el-form-item label="启用自动转发">
                                <el-switch v-model="forwardingConfig.enabled"></el-switch>
                            </el-form-item>
                            <el-form-item label="目标频道">
                                <el-input v-model="forwardingConfig.target_channel" placeholder="输入目标频道名称（支持带@或不带@）" @blur="updateTargetChannelId"></el-input>
                            </el-form-item>
                            <el-form-item label="目标频道ID">
                                <el-input :value="forwardingConfig.resolved_target_channel_id || '未解析'" readonly>
                                    <template #prepend>
                                        <el-icon><InfoFilled /></el-icon>
                                    </template>
                                    <template #append>
                                        <el-button @click="manualResolveTargetChannel" :loading="loading" size="small">
                                            手动解析
                                        </el-button>
                                    </template>
                                </el-input>
                                <div class="form-hint">
                                    <small>此ID由系统自动解析生成，点击"手动解析"可重新解析</small>
                                </div>
                            </el-form-item>
                            <el-form-item label="审核群">
                                <el-input v-model="forwardingConfig.review_group" placeholder="输入审核群链接、ID或用户名" @blur="updateReviewGroupId">
                                    <template #prepend>
                                        <el-button @click="showReviewGroupHelp">💡</el-button>
                                    </template>
                                </el-input>
                                <div class="form-hint">
                                    <small>支持群链接（如：https://t.me/+xxx）、群ID（如：-1001234567890）或群用户名（如：@review_group）。</small>
                                </div>
                            </el-form-item>
                            <el-form-item label="审核群ID">
                                <el-input :value="forwardingConfig.resolved_group_id || '未解析'" readonly>
                                    <template #prepend>
                                        <el-icon><InfoFilled /></el-icon>
                                    </template>
                                    <template #append>
                                        <el-button @click="manualResolveReviewGroup" :loading="loading" size="small">
                                            手动解析
                                        </el-button>
                                    </template>
                                </el-input>
                                <div class="form-hint">
                                    <small>此ID由系统自动解析生成，点击"手动解析"可重新解析</small>
                                </div>
                            </el-form-item>
                            <el-form-item label="转发延迟（秒）">
                                <el-input-number v-model="forwardingConfig.delay" :min="0" :max="3600"></el-input-number>
                                <div class="form-hint">
                                    <small>消息在审核群中停留多长时间后自动转发（0表示不自动转发）</small>
                                </div>
                            </el-form-item>
                            <el-form-item label="转发条件">
                                <el-checkbox-group v-model="forwardingConfig.conditions">
                                    <el-checkbox label="approved">已批准消息</el-checkbox>
                                    <el-checkbox label="auto_approved">自动批准消息</el-checkbox>
                                </el-checkbox-group>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="primary" @click="saveForwardingConfig">保存配置</el-button>
                            </el-form-item>
                        </el-form>
                    </div>
                </el-tab-pane>

                <!-- 过滤设置 -->
                <el-tab-pane label="🛡️ 过滤设置" name="filter">
                    <div class="config-section">
                        <h3>内容过滤配置</h3>
                        <el-form :model="filterConfig" label-width="180px">
                            <el-form-item label="自动过滤广告">
                                <el-switch v-model="filterConfig.auto_filter_ads"></el-switch>
                                <div class="form-hint">
                                    <small>自动拒绝被检测为广告的消息</small>
                                </div>
                            </el-form-item>
                            <el-form-item label="隐藏链接处理策略">
                                <el-radio-group v-model="filterConfig.hidden_link_action">
                                    <el-radio label="remove">移除链接（保留文本）</el-radio>
                                    <el-radio label="keep">保留原样</el-radio>
                                    <el-radio label="expose">显式化链接</el-radio>
                                </el-radio-group>
                                <div class="form-hint">
                                    <small>处理消息中隐藏的URL链接（MessageEntityTextUrl）</small>
                                </div>
                            </el-form-item>
                            <el-form-item label="智能去尾部">
                                <el-switch v-model="filterConfig.smart_tail_removal"></el-switch>
                                <div class="form-hint">
                                    <small>自动移除消息末尾的推广内容</small>
                                </div>
                            </el-form-item>
                            <el-form-item label="结构化广告检测">
                                <el-switch v-model="filterConfig.structural_ad_detection"></el-switch>
                                <div class="form-hint">
                                    <small>检测按钮、隐藏链接等结构化广告</small>
                                </div>
                            </el-form-item>
                            <el-form-item label="OCR文字识别">
                                <el-switch v-model="filterConfig.ocr_detection"></el-switch>
                                <div class="form-hint">
                                    <small>从图片中提取文字进行广告检测</small>
                                </div>
                            </el-form-item>
                            <el-form-item label="重复消息检测">
                                <el-switch v-model="filterConfig.duplicate_detection"></el-switch>
                                <div class="form-hint">
                                    <small>检测并过滤重复的消息</small>
                                </div>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="primary" @click="saveFilterConfig">保存配置</el-button>
                                <el-button @click="resetFilterConfig">重置默认</el-button>
                            </el-form-item>
                        </el-form>
                    </div>
                </el-tab-pane>

                <!-- 系统设置 -->
                <el-tab-pane label="🔧 系统设置" name="system">
                    <div class="config-section">
                        <h3>系统参数配置</h3>
                        <el-form :model="systemConfig" label-width="150px">
                            <el-form-item label="审核模式">
                                <el-radio-group v-model="systemConfig.review_mode">
                                    <el-radio label="manual">手动审核</el-radio>
                                    <el-radio label="auto">自动审核</el-radio>
                                    <el-radio label="hybrid">混合模式</el-radio>
                                </el-radio-group>
                            </el-form-item>
                            <el-form-item label="消息保留天数">
                                <el-input-number v-model="systemConfig.retention_days" :min="1" :max="365"></el-input-number>
                            </el-form-item>
                            <el-form-item label="最大并发数">
                                <el-input-number v-model="systemConfig.max_concurrent" :min="1" :max="100"></el-input-number>
                            </el-form-item>
                            <el-form-item label="日志级别">
                                <el-select v-model="systemConfig.log_level">
                                    <el-option label="DEBUG" value="debug"></el-option>
                                    <el-option label="INFO" value="info"></el-option>
                                    <el-option label="WARNING" value="warning"></el-option>
                                    <el-option label="ERROR" value="error"></el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item label="历史消息采集数">
                                <el-input-number v-model="systemConfig.history_message_limit" :min="1" :max="1000" placeholder="50"></el-input-number>
                                <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                    首次采集或重启后从频道获取的历史消息条数
                                </div>
                            </el-form-item>
                            <el-form-item label="频道落款">
                                <el-input 
                                    type="textarea" 
                                    v-model="systemConfig.channel_signature" 
                                    placeholder="输入频道落款内容，支持多行（用回车换行）"
                                    :rows="4">
                                </el-input>
                                <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                    消息经过智能去除尾部内容后，会自动添加此落款到消息尾部
                                </div>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="primary" @click="saveSystemConfig">保存配置</el-button>
                                <el-button @click="resetSystemConfig">重置默认</el-button>
                            </el-form-item>
                        </el-form>
                    </div>
                </el-tab-pane>
            </el-tabs>
        </div>
        
        <!-- 状态消息 -->
        <div v-if="statusMessage" class="status-message" :class="statusType">
            {{ statusMessage }}
        </div>
        
        <!-- 加载遮罩 -->
        <div v-if="loading" class="loading-overlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p>{{ loadingMessage }}</p>
            </div>
        </div>
    </div>
</body>
</html> 