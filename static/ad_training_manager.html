<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂπøÂëäÊ£ÄÊµãÊï∞ÊçÆÁÆ°ÁêÜ</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="assets/css/element-plus.css">
    <link rel="stylesheet" href="assets/css/element-plus-fixes.css">
    <link rel="stylesheet" href="assets/css/modern-ui.css">
    <link rel="stylesheet" href="assets/css/training-manager.css">
</head>
<body>
    <div id="app">
        <!-- ÂØºËà™Ê†è -->
        <nav-bar page-title="ü§ñ AIËÆ≠ÁªÉ‰∏≠ÂøÉ"></nav-bar>
        
        <!-- Â≠êÂØºËà™ -->
        <training-nav active-tab="ad"></training-nav>

        <div class="container">
            <!-- ÁªüËÆ°‰ø°ÊÅØÊ†è -->
            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-label">ÊÄªÊ†∑Êú¨Êï∞Ôºö</span>
                    <span class="stat-value">{{ stats.totalSamples }}</span>
                </div>
                <el-divider direction="vertical"></el-divider>
                <div class="stat-item">
                    <span class="stat-label">ÂéªÈáçÂêéÊï∞ÈáèÔºö</span>
                    <span class="stat-value">{{ stats.uniqueSamples }}</span>
                </div>
                <el-divider direction="vertical"></el-divider>
                <div class="stat-item">
                    <span class="stat-label">Â™í‰ΩìÊñá‰ª∂Ôºö</span>
                    <span class="stat-value">{{ stats.mediaFiles }}</span>
                </div>
                <el-divider direction="vertical"></el-divider>
                <div class="stat-item">
                    <span class="stat-label">Â≠òÂÇ®Âç†Áî®Ôºö</span>
                    <span class="stat-value">{{ formatSize(stats.storageSize) }}</span>
                </div>
            </div>

            <!-- Êìç‰ΩúÂ∑•ÂÖ∑Ê†è -->
            <el-card class="toolbar-card">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <el-input 
                            v-model="searchText" 
                            placeholder="ÊêúÁ¥¢ÂπøÂëäËÆ≠ÁªÉÊ†∑Êú¨..." 
                            style="width: 300px"
                            @keyup.enter="loadSamples"
                            clearable>
                            <template #prefix>
                                <el-icon><Search /></el-icon>
                            </template>
                        </el-input>
                        <el-select v-model="filterType" placeholder="Á≠õÈÄâÁ±ªÂûã" style="width: 150px" @change="loadSamples">
                            <el-option label="ÂÖ®ÈÉ®" value="all"></el-option>
                            <el-option label="ÊúâÂ™í‰Ωì" value="with_media"></el-option>
                            <el-option label="Á∫ØÊñáÊú¨" value="text_only"></el-option>
                            <el-option label="Áñë‰ººÈáçÂ§ç" value="duplicate"></el-option>
                        </el-select>
                    </div>
                    <div class="toolbar-right">
                        <el-button @click="showDuplicates" type="warning">
                            <el-icon><CopyDocument /></el-icon>
                            Ê£ÄÊµãÈáçÂ§ç
                        </el-button>
                        <el-button @click="optimizeStorage" type="info">
                            <el-icon><FolderOpened /></el-icon>
                            ‰ºòÂåñÂ≠òÂÇ®
                        </el-button>
                        <el-button @click="reloadModel" type="success">
                            <el-icon><Refresh /></el-icon>
                            ÈáçËΩΩÊ®°Âûã
                        </el-button>
                        <el-button @click="openMediaManager" type="primary">
                            <el-icon><Picture /></el-icon>
                            Â™í‰ΩìÊñá‰ª∂ÁÆ°ÁêÜ
                        </el-button>
                        <el-button @click="deleteSelected" type="danger" :disabled="!selectedSamples.length">
                            <el-icon><Delete /></el-icon>
                            ÊâπÈáèÂà†Èô§ ({{ selectedSamples.length }})
                        </el-button>
                    </div>
                </div>
            </el-card>

            <!-- Êï∞ÊçÆË°®Ê†º -->
            <el-card class="table-card">
                <el-table 
                    :data="samples" 
                    stripe 
                    border
                    v-loading="loading"
                    @selection-change="handleSelectionChange"
                    row-key="id"
                    style="width: 100%">
                    
                    <el-table-column type="selection" width="55"></el-table-column>
                    
                    <el-table-column prop="id" label="ID" width="80" sortable></el-table-column>
                    
                    <el-table-column label="ÂÜÖÂÆπÈ¢ÑËßà" min-width="400">
                        <template #default="scope">
                            <div class="content-preview" @click="showDetail(scope.row)">
                                {{ truncateText(scope.row.content, 100) }}
                            </div>
                            <div v-if="scope.row.similarity_group" class="similarity-tag">
                                <el-tag type="warning" size="small">
                                    Áõ∏‰ººÁªÑ #{{ scope.row.similarity_group }}
                                </el-tag>
                            </div>
                        </template>
                    </el-table-column>
                    
                    <el-table-column label="Â™í‰Ωì" width="120">
                        <template #default="scope">
                            <div v-if="scope.row.media_files && scope.row.media_files.length" class="media-preview">
                                <el-image 
                                    v-for="(media, idx) in scope.row.media_files.slice(0, 2)" 
                                    :key="idx"
                                    :src="'/media/' + media"
                                    :preview-src-list="scope.row.media_files.map(m => '/media/' + m)"
                                    fit="cover"
                                    style="width: 40px; height: 40px; margin-right: 5px">
                                </el-image>
                                <span v-if="scope.row.media_files.length > 2" class="media-count">
                                    +{{ scope.row.media_files.length - 2 }}
                                </span>
                            </div>
                            <span v-else class="no-media">Êó†</span>
                        </template>
                    </el-table-column>
                    
                    <el-table-column prop="source" label="Êù•Ê∫ê" width="150">
                        <template #default="scope">
                            <el-tag :type="getSourceType(scope.row.source)">
                                {{ formatSource(scope.row.source) }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    
                    <el-table-column prop="created_at" label="ÂàõÂª∫Êó∂Èó¥" width="180" sortable>
                        <template #default="scope">
                            {{ formatTime(scope.row.created_at) }}
                        </template>
                    </el-table-column>
                    
                    <el-table-column label="Êìç‰Ωú" width="150" fixed="right">
                        <template #default="scope">
                            <el-button type="danger" size="small" @click="deleteSample(scope.row)">
                                Âà†Èô§
                            </el-button>
                        </template>
                    </el-table-column>
                </el-table>
                
                <!-- ÂàÜÈ°µ -->
                <el-pagination
                    v-if="totalCount > pageSize"
                    @current-change="handlePageChange"
                    :current-page="currentPage"
                    :page-size="pageSize"
                    :total="totalCount"
                    layout="total, prev, pager, next"
                    style="margin-top: 20px; text-align: center;">
                </el-pagination>
            </el-card>
        </div>

        <!-- ËØ¶ÊÉÖÂØπËØùÊ°Ü -->
        <el-dialog v-model="detailDialog" title="Ê†∑Êú¨ËØ¶ÊÉÖ" width="60%">
            <div v-if="currentSample">
                <el-descriptions :column="2" border>
                    <el-descriptions-item label="ID">{{ currentSample.id }}</el-descriptions-item>
                    <el-descriptions-item label="Êù•Ê∫ê">
                        <el-tag :type="getSourceType(currentSample.source)">
                            {{ formatSource(currentSample.source) }}
                        </el-tag>
                    </el-descriptions-item>
                    <el-descriptions-item label="ÊèèËø∞">{{ currentSample.description || 'Êó†' }}</el-descriptions-item>
                    <el-descriptions-item label="ÂàõÂª∫Êó∂Èó¥">{{ formatTime(currentSample.created_at) }}</el-descriptions-item>
                </el-descriptions>
                
                <el-divider></el-divider>
                
                <h4>ÂÜÖÂÆπÔºö</h4>
                <div class="detail-content">{{ currentSample.content }}</div>
                
                <div v-if="currentSample.media_files && currentSample.media_files.length">
                    <el-divider></el-divider>
                    <h4>Â™í‰ΩìÊñá‰ª∂Ôºö</h4>
                    <div class="media-grid">
                        <el-image 
                            v-for="(media, idx) in currentSample.media_files" 
                            :key="idx"
                            :src="'/media/' + media"
                            :preview-src-list="currentSample.media_files.map(m => '/media/' + m)"
                            fit="cover"
                            style="width: 150px; height: 150px; margin: 5px">
                        </el-image>
                    </div>
                </div>
            </div>
        </el-dialog>

        <!-- ÈáçÂ§çÊ£ÄÊµãÂØπËØùÊ°Ü -->
        <el-dialog v-model="duplicateDialog" title="ÈáçÂ§çÊ†∑Êú¨Ê£ÄÊµã" width="80%">
            <div v-loading="duplicateLoading">
                <el-alert v-if="duplicateGroups.length" type="warning" :closable="false" style="margin-bottom: 20px">
                    ÂèëÁé∞ {{ duplicateGroups.length }} ÁªÑÈáçÂ§ç/Áõ∏‰ººÊ†∑Êú¨ÔºåÂÖ± {{ duplicateSamplesCount }} ‰∏™Ê†∑Êú¨
                </el-alert>
                
                <div v-for="(group, idx) in duplicateGroups" :key="idx" class="duplicate-group">
                    <div class="group-header">
                        <span>Áõ∏‰ººÁªÑ #{{ idx + 1 }} (Áõ∏‰ººÂ∫¶: {{ group.similarity }}%)</span>
                        <el-button type="danger" size="small" @click="mergeGroup(group)">
                            ÂêàÂπ∂‰∏∫‰∏Ä‰∏™
                        </el-button>
                    </div>
                    <div class="group-samples">
                        <div v-for="sample in group.samples" :key="sample.id" class="duplicate-sample">
                            <el-checkbox v-model="sample.keep">‰øùÁïô</el-checkbox>
                            <span class="sample-id">ID: {{ sample.id }}</span>
                            <span class="sample-preview">{{ truncateText(sample.content, 50) }}</span>
                        </div>
                    </div>
                </div>

                <div v-if="duplicateGroups.length" style="text-align: center; margin-top: 20px">
                    <el-button type="primary" @click="applyDeduplicate">Â∫îÁî®ÂéªÈáç</el-button>
                </div>
            </div>
        </el-dialog>
    </div>

    <script src="assets/js/vue.prod.js"></script>
    <script src="assets/js/element-plus.js"></script>
    <script src="assets/js/axios.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/components/navbar.js"></script>
    <script src="assets/js/components/training-nav.js"></script>
    <script src="assets/js/components/ad-training-manager.js"></script>
</body>
</html>