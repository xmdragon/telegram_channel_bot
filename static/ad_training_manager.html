<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂπøÂëäÊ£ÄÊµãÊï∞ÊçÆÁÆ°ÁêÜ</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="assets/css/element-plus.css">
    <link rel="stylesheet" href="assets/css/element-plus-fixes.css">
    <link rel="stylesheet" href="assets/css/modern-ui.css">
    <link rel="stylesheet" href="assets/css/training-common.css">
    <link rel="stylesheet" href="assets/css/training-manager.css">
    <link rel="stylesheet" href="assets/css/training-nav.css">
</head>
<body>
    <div id="app">
        <!-- ÂØºËà™Ê†è -->
        <nav-bar page-title="ü§ñ AIËÆ≠ÁªÉ‰∏≠ÂøÉ"></nav-bar>
        
        <div class="container">
            <!-- Â≠êÂØºËà™ -->
            <training-nav active-tab="ad"></training-nav>
            <!-- ÁªüËÆ°‰ø°ÊÅØÊ†è -->
            <div class="stats-section compact">
                <div class="stats-inline">
                    <div class="stat-item-inline">
                        <span class="stat-label">ÊÄªÊ†∑Êú¨Êï∞:</span>
                        <span class="stat-value">{{ stats.totalSamples }}</span>
                    </div>
                    <div class="stat-item-inline">
                        <span class="stat-label">ÂéªÈáçÂêéÊï∞Èáè:</span>
                        <span class="stat-value">{{ stats.uniqueSamples }}</span>
                    </div>
                    <div class="stat-item-inline">
                        <span class="stat-label">Â™í‰ΩìÊñá‰ª∂:</span>
                        <span class="stat-value">{{ stats.mediaFiles }}</span>
                    </div>
                    <div class="stat-item-inline">
                        <span class="stat-label">Â≠òÂÇ®Âç†Áî®:</span>
                        <span class="stat-value">{{ formatSize(stats.storageSize) }}</span>
                    </div>
                </div>
            </div>

            <!-- Êìç‰ΩúÂ∑•ÂÖ∑Ê†è -->
            <div class="toolbar-section">
                <div class="toolbar-card">
                    <div class="toolbar-content">
                        <!-- ÊêúÁ¥¢Ê†è -->
                        <div class="search-bar">
                            <el-input 
                                v-model="searchText" 
                                placeholder="ÊêúÁ¥¢ÂπøÂëäËÆ≠ÁªÉÊ†∑Êú¨..." 
                                class="search-input"
                                @keyup.enter="loadSamples"
                                clearable>
                                <template #prefix>
                                    <el-icon><Search /></el-icon>
                                </template>
                            </el-input>
                            <el-select v-model="filterType" placeholder="Á≠õÈÄâÁ±ªÂûã" class="filter-select" @change="loadSamples">
                                <el-option label="ÂÖ®ÈÉ®" value="all"></el-option>
                                <el-option label="ÊúâÂ™í‰Ωì" value="with_media"></el-option>
                                <el-option label="Á∫ØÊñáÊú¨" value="text_only"></el-option>
                                <el-option label="Áñë‰ººÈáçÂ§ç" value="duplicate"></el-option>
                            </el-select>
                        </div>
                        <!-- ÊåâÈíÆÊ†è -->
                        <div class="button-bar">
                            <el-button @click="showDuplicates" type="warning" class="btn-warning">
                                <el-icon><CopyDocument /></el-icon>
                                Ê£ÄÊµãÈáçÂ§ç
                            </el-button>
                            <el-button @click="optimizeStorage" type="info">
                                <el-icon><FolderOpened /></el-icon>
                                ‰ºòÂåñÂ≠òÂÇ®
                            </el-button>
                            <el-button @click="reloadModel" type="success" class="btn-success">
                                <el-icon><Refresh /></el-icon>
                                ÈáçËΩΩÊ®°Âûã
                            </el-button>
                            <el-button @click="openMediaManager" type="primary" class="btn-primary">
                                <el-icon><Picture /></el-icon>
                                Â™í‰ΩìÁÆ°ÁêÜ
                            </el-button>
                            <el-button @click="deleteSelected" type="danger" class="btn-danger" :disabled="!selectedSamples.length">
                                <el-icon><Delete /></el-icon>
                                ÊâπÈáèÂà†Èô§ ({{ selectedSamples.length }})
                            </el-button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Êï∞ÊçÆË°®Ê†º -->
            <div class="table-section">
                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title">üéØ ÂπøÂëäÊ£ÄÊµãÊ†∑Êú¨Êï∞ÊçÆ</h3>
                    </div>
                    <div class="table-content">
                        <el-table 
                            :data="samples" 
                            stripe 
                            border
                            v-loading="loading"
                            @selection-change="handleSelectionChange"
                            row-key="id"
                            class="data-table">
                    
                    <el-table-column type="selection" width="55"></el-table-column>
                    
                    <el-table-column prop="id" label="ID" width="80" sortable></el-table-column>
                    
                    <el-table-column label="ÂÜÖÂÆπÈ¢ÑËßà" min-width="400">
                        <template #default="scope">
                            <div class="content-preview" @click="showDetail(scope.row)">
                                {{ truncateText(scope.row.content, 100) }}
                            </div>
                            <div v-if="scope.row.similarity_group" class="similarity-tag">
                                <el-tag type="warning" size="small">
                                    Áõ∏‰ººÁªÑ #{{ scope.row.similarity_group }}
                                </el-tag>
                            </div>
                        </template>
                    </el-table-column>
                    
                    <el-table-column label="Â™í‰Ωì" width="120">
                        <template #default="scope">
                            <div v-if="scope.row.media_files && scope.row.media_files.length" class="media-preview">
                                <el-image 
                                    v-for="(media, idx) in scope.row.media_files.slice(0, 2)" 
                                    :key="idx"
                                    :src="'/media/' + media"
                                    :preview-src-list="scope.row.media_files.map(m => '/media/' + m)"
                                    fit="cover"
                                    class="media-preview-thumb">
                                </el-image>
                                <span v-if="scope.row.media_files.length > 2" class="media-count">
                                    +{{ scope.row.media_files.length - 2 }}
                                </span>
                            </div>
                            <span v-else class="no-media">Êó†</span>
                        </template>
                    </el-table-column>
                    
                    <el-table-column prop="source" label="Êù•Ê∫ê" width="150">
                        <template #default="scope">
                            <el-tag :type="getSourceType(scope.row.source)">
                                {{ formatSource(scope.row.source) }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    
                    <el-table-column prop="created_at" label="ÂàõÂª∫Êó∂Èó¥" width="180" sortable>
                        <template #default="scope">
                            {{ formatTime(scope.row.created_at) }}
                        </template>
                    </el-table-column>
                    
                    <el-table-column label="Êìç‰Ωú" width="150" fixed="right">
                        <template #default="scope">
                            <el-button type="danger" size="small" class="btn-danger" @click="deleteSample(scope.row)">
                                Âà†Èô§
                            </el-button>
                        </template>
                    </el-table-column>
                        </el-table>
                    </div>
                    
                    <!-- ÂàÜÈ°µ -->
                    <div class="pagination-section" v-if="totalCount > pageSize">
                        <el-pagination
                            @current-change="handlePageChange"
                            :current-page="currentPage"
                            :page-size="pageSize"
                            :total="totalCount"
                            layout="total, prev, pager, next"
                            class="pagination">
                        </el-pagination>
                    </div>
                </div>
            </div>
        </div>

        <!-- ËØ¶ÊÉÖÂØπËØùÊ°Ü -->
        <el-dialog v-model="detailDialog" title="Ê†∑Êú¨ËØ¶ÊÉÖ" width="60%">
            <div v-if="currentSample">
                <el-descriptions :column="2" border>
                    <el-descriptions-item label="ID">{{ currentSample.id }}</el-descriptions-item>
                    <el-descriptions-item label="Êù•Ê∫ê">
                        <el-tag :type="getSourceType(currentSample.source)">
                            {{ formatSource(currentSample.source) }}
                        </el-tag>
                    </el-descriptions-item>
                    <el-descriptions-item label="ÊèèËø∞">{{ currentSample.description || 'Êó†' }}</el-descriptions-item>
                    <el-descriptions-item label="ÂàõÂª∫Êó∂Èó¥">{{ formatTime(currentSample.created_at) }}</el-descriptions-item>
                </el-descriptions>
                
                <el-divider></el-divider>
                
                <h4>ÂÜÖÂÆπÔºö</h4>
                <div class="detail-content">{{ currentSample.content }}</div>
                
                <div v-if="currentSample.media_files && currentSample.media_files.length">
                    <el-divider></el-divider>
                    <h4>Â™í‰ΩìÊñá‰ª∂Ôºö</h4>
                    <div class="media-grid">
                        <el-image 
                            v-for="(media, idx) in currentSample.media_files" 
                            :key="idx"
                            :src="'/media/' + media"
                            :preview-src-list="currentSample.media_files.map(m => '/media/' + m)"
                            fit="cover"
                            class="media-preview-large">
                        </el-image>
                    </div>
                </div>
            </div>
        </el-dialog>

        <!-- ÈáçÂ§çÊ£ÄÊµãÂØπËØùÊ°Ü -->
        <el-dialog v-model="duplicateDialog" title="ÈáçÂ§çÊ†∑Êú¨Ê£ÄÊµã" width="80%">
            <div v-loading="duplicateLoading">
                <el-alert v-if="duplicateGroups.length" type="warning" :closable="false" class="mb-4">
                    ÂèëÁé∞ {{ duplicateGroups.length }} ÁªÑÈáçÂ§ç/Áõ∏‰ººÊ†∑Êú¨ÔºåÂÖ± {{ duplicateSamplesCount }} ‰∏™Ê†∑Êú¨
                </el-alert>
                
                <div v-for="(group, idx) in duplicateGroups" :key="idx" class="duplicate-group">
                    <div class="group-header">
                        <span>Áõ∏‰ººÁªÑ #{{ idx + 1 }} (Áõ∏‰ººÂ∫¶: {{ group.similarity }}%)</span>
                        <el-button type="danger" size="small" @click="mergeGroup(group)">
                            ÂêàÂπ∂‰∏∫‰∏Ä‰∏™
                        </el-button>
                    </div>
                    <div class="group-samples">
                        <div v-for="sample in group.samples" :key="sample.id" class="duplicate-sample">
                            <el-checkbox v-model="sample.keep">‰øùÁïô</el-checkbox>
                            <span class="sample-id">ID: {{ sample.id }}</span>
                            <span class="sample-preview">{{ truncateText(sample.content, 50) }}</span>
                        </div>
                    </div>
                </div>

                <div v-if="duplicateGroups.length" class="text-center mt-4">
                    <el-button type="primary" @click="applyDeduplicate">Â∫îÁî®ÂéªÈáç</el-button>
                </div>
            </div>
        </el-dialog>
    </div>

    <script src="assets/js/vue.prod.js"></script>
    <script src="assets/js/element-plus.js"></script>
    <script src="assets/js/axios.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/components/navbar.js"></script>
    <script src="assets/js/components/training-nav.js"></script>
    <script src="assets/js/components/ad-training-manager.js"></script>
</body>
</html>